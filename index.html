<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <title>Placar Vôlei</title>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #fff;
      --accent-color: #545454;
      --input-bg-color: #f0f0f0;
      --input-text-color: #1a1a1a;
      --menu-bg-color: #333;
      --menu-hover-bg-color: #555;
      --list-item-bg: #3a3a3a;
      --gear-button-bg: rgba(0,0,0,.6);
      --neutral-hover-bg: rgba(51,51,51,.8);
      --victory-bg-start: #4CAF50;
      --victory-bg-end: #8BC34A;
      --victory-text-color: #fff;
      --victory-shadow-color: rgba(0,0,0,.8);
      --crown-color: gold;
      --star-color: gold;
      --modal-bg: rgba(0,0,0,.8);
      --modal-content-bg: #2a2a2a;
      --modal-text-color: #fff;
      --modal-button-bg: #007bff;
      --modal-button-hover-bg: #0056b3;
      --modal-button-text: #fff;
      --card-bg-color: #2c2c2c;
      --card-border-color: #666;
      --collapsible-header-bg: #444;
      --collapsible-header-hover-bg: #555;
      --setting-item-bg: #3a3a3a;
      --setting-section-bg: #222;
      --setting-item-border: rgba(255,255,255,.1);
      /* Novas variáveis para cores dos cartões de agendamento */
      --appointment-card-bg: #2c2c2c; /* Fundo do cartão */
      --appointment-card-border: #007bff; /* Borda do cartão (azul) */
      --appointment-card-past-bg: #3a3a3a; /* Fundo do cartão passado */
      --appointment-icon-color: #fff; /* Ícones brancos para tema escuro */
    }
    body.light-theme {
      --bg-color: #f0f0f0;
      --text-color: #1a1a1a;
      --accent-color: #ccc;
      --input-bg-color: #fff;
      --input-text-color: #1a1a1a;
      --menu-bg-color: #eee;
      --menu-hover-bg-color: #ddd;
      --list-item-bg: #e0e0e0;
      --gear-button-bg: rgba(255,255,255,.6);
      --neutral-hover-bg: rgba(204,204,204,.8);
      --victory-bg-start: #60B360;
      --victory-bg-end: #A0D8A0;
      --victory-text-color: #1a1a1a;
      --victory-shadow-color: rgba(255,255,255,.8);
      --crown-color: #DAA520;
      --star-color: #DAA520;
      --modal-bg: rgba(255,255,255,.8);
      --modal-content-bg: #fff;
      --modal-text-color: #1a1a1a;
      --modal-button-bg: #4682B4;
      --modal-button-hover-bg: #32628C;
      --modal-button-text: #fff;
      --card-bg-color: #f8f8f8;
      --card-border-color: #aaa;
      --collapsible-header-bg: #ddd;
      --collapsible-header-hover-bg: #ccc;
      --setting-item-bg: #e0e0e0;
      --setting-section-bg: #f0f0f0;
      --setting-item-border: rgba(0,0,0,.1);
      /* Novas variáveis para cores dos cartões de agendamento - Tema Claro */
      --appointment-card-bg: #f0f0f0;
      --appointment-card-border: #4682B4; /* Borda do cartão (azul) */
      --appointment-card-past-bg: #e0e0e0; /* Fundo do cartão passado */
      --appointment-icon-color: #666; /* Ícones cinza escuro para tema claro */
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color .3s ease, color .3s ease;
    }
    #pontuacao.section {
      padding: 0;
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .scoreboard {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }
    .team-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding-top: 20px;
      text-align: center;
      touch-action: none;
      position: relative;
    }
    .score {
      font-size: 15rem;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      user-select: none;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,.6);
    }
    .team-name {
      font-size: 2rem;
      margin-bottom: .5rem;
      color: #fff;
    }
    .set-indicators {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 5px;
      z-index: 5;
    }
    .set-indicators.left {
      left: 10px;
    }
    .set-indicators.right {
      flex-direction: column;
      right: 10px;
    }
    .set-star {
      font-size: 1.5rem;
      color: var(--star-color);
      text-shadow: 1px 1px 2px rgba(0,0,0,.3);
    }
    .player-info-container {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
      padding: 2px;
      background-color: rgba(0,0,0,.1);
      border-radius: 6px;
      max-width: 120px;
      box-shadow: none;
      transition: background-color .3s ease;
    }
    .player-info-container.top-left {
      top: 10px;
      left: 10px;
    }
    .player-info-container.top-right {
      top: 10px;
      right: 10px;
    }
    .player-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: .8rem;
      color: rgba(255,255,255,.8);
      text-align: center;
      width: 100%;
      max-height: 100px;
      overflow-y: auto;
      opacity: 1;
    }
    .player-list li {
      background: none;
      padding: 1px 0;
      margin-bottom: 0;
      border-radius: 0;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
    }
    .btn {
      background-color: var(--accent-color);
      color: var(--text-color);
      border: none;
      padding: .5rem 1rem;
      margin: .5rem 0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color .3s ease, color .3s ease;
    }
    .gear-button {
      position: fixed;     
      background-color: var(--gear-button-bg);
      border-radius: .4rem;
      border-style: unset;
      top: 1rem;
      right: 1rem;
      width: 2rem;
      height: 2rem;
      z-index: 1001;
      transition: background-color .3s ease;
    }
    .gear-button i {
      color: var(--text-color);
      transition: color .3s ease;
    }
    .menu {
      position: fixed;
      top: 3.5rem;
      right: 1rem;
      background-color: var(--menu-bg-color);
      border-radius: 8px;
      overflow: hidden;
      display: none;
      flex-direction: column;
      z-index: 1002;
      transition: background-color .3s ease;
    }
    .menu.show {
      display: flex !important;
    }
    .menu button {
      background: none;
      border: none;
      color: var(--text-color);
      padding: 1rem;
      text-align: left;
      width: 200px;
      cursor: pointer;
      transition: background-color .3s ease, color .3s ease;
    }
    .menu button:hover {
      background-color: var(--menu-hover-bg-color);
    }
    .menu button.disabled {
      opacity: .5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .section {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      overflow-y: auto;
      padding: 1rem;
      opacity: 0;
      pointer-events: none;
      transform: scale(.9);
      transition: opacity .4s ease-in-out, transform .4s ease-in-out;
      z-index: 1;
    }
    .active {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
      z-index: 2;
    }
    input, select {
      height: 2.5rem;
      width: 100%;
      padding: .5rem;
      margin: .5rem 0;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid var(--accent-color);
      color: var(--input-text-color);
      background-color: var(--input-bg-color);
      transition: background-color .3s ease, color .3s ease, border-color .3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--modal-button-bg);
      box-shadow: 0 0 0 2px rgba(0,123,255,.25);
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    ul li {
      background: var(--list-item-bg);
      padding: .5rem;
      margin-bottom: .25rem;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      transition: background-color .3s ease;
    }
    ul li span {
      flex: 1;
    }
    .start-game-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      padding: 1.5rem 3rem;
      font-size: 2rem;
      z-index: 100;
      background-color: #28a745;
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,.3);
      cursor: pointer;
      transition: background-color .3s ease, transform .3s ease;
    }
    .start-game-button:hover {
      background-color: #218838;
      transform: translate(-50%,-50%) scale(1.05);
    }
    .start-game-button.disabled-visual {
      background-color: #6c757d;
      cursor: not-allowed;
      box-shadow: none;
      transform: translate(-50%,-50%);
    }
    .start-game-button.disabled-visual:hover {
      background-color: #6c757d;
      transform: translate(-50%,-50%);
    }
    .adicionar {
      display: flex;
      gap: 1rem;
    }
    #playerCounter {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: right;
      margin: .5rem 0;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,.5);
      z-index: 999;
    }
    .overlay.show {
      display: block;
    }
    .config-group {
      margin-bottom: .75rem;
      padding: .75rem;
      border-radius: 8px;
      background-color: var(--setting-item-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,.15);
      transition: background-color .3s ease, box-shadow .3s ease;
      border: 1px solid var(--setting-item-border);
    }
    .config-group:last-child {
      margin-bottom: 0;
    }
    .config-group label {
      display: block;
      margin-bottom: .5rem;
      font-weight: bold;
      color: var(--text-color);
    }
    .collapsible-container {
      margin-top: 20px;
      margin-bottom: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
    }
    .collapsible-header {
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--collapsible-header-bg);
      padding: .8rem 1rem;
      cursor: pointer;
      transition: background-color .3s ease, box-shadow .3s ease;
    }
    .collapsible-header:hover {
      background-color: var(--collapsible-header-hover-bg);
    }
    .collapsible-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--text-color);
    }
    .collapsible-arrow {
      font-size: 1.2rem;
      transition: transform .3s ease;
    }
    .collapsible-arrow.rotated {
      transform: rotate(90deg);
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height .4s ease-out, padding .4s ease-out;
      padding: 0 1rem;
      background-color: var(--setting-section-bg);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .collapsible-content.show {
      border-radius: 0px 0px 8px 8px;
      max-height: 600px;
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
    .player-info-container.hidden-players {
      display: none;
    }
    .color-picker-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 0;
    }
    .color-picker-group label {
      flex-grow: 1;
      margin-bottom: 0;
    }
    .color-picker-group input[type="color"] {
      width: 40px;
      height: 40px;
      padding: 0;
      border: 1px solid var(--accent-color);
      border-radius: 5px;
      cursor: pointer;
      background-color: transparent;
      transition: border-color .3s ease;
    }
    .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    .color-picker-group input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 5px;
    }
    .color-picker-group input[type="color"]:focus {
      border-color: var(--modal-button-bg);
      box-shadow: 0 0 0 2px rgba(0,123,255,.25);
    }
    .checkbox-group {
      display: flex;
      flex-grow: 1;
      align-items: center;
      justify-content: space-between;
      background-color: var(--setting-item-bg);
      padding: .75rem;
      border-radius: 8px;
      margin-bottom: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      border: 1px solid var(--setting-item-border);
      transition: background-color .3s ease, box-shadow .3s ease;
    }
    .checkbox-group label {
      margin-bottom: 0;
      flex-grow: 1;
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--modal-button-bg);
    }
    @media (orientation: landscape) {
      .scoreboard {
        flex-direction: row;
      }
      .score {
        font-size: 10rem;
      }
      .team-name {
        font-size: 2rem;
      }
      .player-info-container {
        max-width: 100px;
        top: 10px;
      }
      .player-list {
        font-size: .7rem;
        max-height: 70px;
      }
      .set-indicators.left {
        flex-direction: column;
      }
    }
    @media (max-width: 480px) {
      .score {
        font-size: 15rem;
      }
    }
    .victory-elements {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity .5s ease-out;
      z-index: 10;
    }
    .victory-elements.show {
      opacity: 1;
    }
    .crown-container {
      position: absolute;
      top: 20%;
      transform: translateX(-50%);
      left: 50%;
      z-index: 20;
      opacity: 0;
      animation: crownAppear 1.5s ease-out forwards;
    }
    .crown-icon {
      font-size: 8rem;
      color: var(--crown-color);
      text-shadow: 2px 2px 5px rgba(0,0,0,.5);
    }
    .confetti-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .confetti-piece {
      position: absolute;
      background-color: #f00;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      opacity: 0;
      animation-fill-mode: forwards;
    }
    @keyframes scaleIn {
      from { transform: scale(.5); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes crownAppear {
      0% { transform: translate(-50%,-100px) scale(.5); opacity: 0; }
      50% { transform: translate(-50%,20px) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%,0) scale(1); opacity: 1; }
    }
    @keyframes confettiFall {
      from { transform: translate(0,0) rotate(0deg); opacity: 1; }
      to { transform: translate(var(--confetti-end-x), var(--confetti-end-y)) rotate(var(--confetti-rotate-deg)); opacity: 0; }
    }
    @keyframes scoreIncreaseAnim {
      0% { transform: scale(1); color: #fff; }
      50% { transform: scale(1.1); color: #8bc34a; }
      100% { transform: scale(1); color: #fff; }
    }
    @keyframes scoreDecreaseAnim {
      0% { transform: scale(1); color: #fff; }
      50% { transform: scale(.9); color: #ff6347; }
      100% { transform: scale(1); color: #fff; }
    }
    .score.increase-anim {
      animation: scoreIncreaseAnim .3s ease-out forwards;
    }
    .score.decrease-anim {
      animation: scoreDecreaseAnim .3s ease-out forwards;
    }
    .game-over-modal, .increase-score-modal, .start-game-modal, .super-victory-modal, .custom-message-modal, .custom-confirmation-modal, .manage-team-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-bg);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity .3s ease-out;
    }
    .game-over-modal.show, .increase-score-modal.show, .start-game-modal.show, .super-victory-modal.show, .custom-message-modal.show, .custom-confirmation-modal.show, .manage-team-modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content, .increase-score-content, .super-victory-content, .custom-message-content, .custom-confirmation-content, .manage-team-content {
      background-color: var(--modal-content-bg);
      padding: clamp(10px,4vw,20px);
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,.3);
      max-width: 90vw;
      max-height: 90vh;
      width: clamp(250px,85vw,380px);
      transform: translateY(-20px);
      opacity: 0;
      animation: modalPopIn .4s ease-out forwards;
      color: var(--modal-text-color);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      gap: 10px;
    }
    .start-game-content {
      background-color: var(--modal-content-bg);
      padding: clamp(15px,5vw,30px);
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,.3);
      max-width: 95vw;
      max-height: 95vh;
      width: clamp(280px,90vw,450px);
      transform: translateY(-20px);
      opacity: 0;
      animation: modalPopIn .4s ease-out forwards;
      color: var(--modal-text-color);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      gap: 15px;
    }
    .modal-content h3, .increase-score-content h3, .super-victory-content h3, .start-game-content h3, .custom-message-content h3, .custom-confirmation-content h3, .manage-team-content h3 {
      font-size: clamp(1.6rem,5.5vw,2.2rem);
      margin-bottom: 0;
    }
    .modal-content p, .increase-score-content p, .super-victory-content p, .start-game-content p, .custom-message-content p, .custom-confirmation-content p, .manage-team-content p {
      font-size: clamp(.9rem,3vw,1.3rem);
      margin-bottom: 0;
    }
    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      justify-content: space-evenly;
      flex-wrap: wrap;
    }
    .modal-buttons button {
      background-color: var(--modal-button-bg);
      color: var(--modal-button-text);
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: clamp(.9rem,3vw,1.1rem);
      font-weight: bold;
      cursor: pointer;
      transition: background-color .2s ease;
      flex: 1;
      min-width: 90px;
    }
    .modal-buttons button:hover {
      background-color: var(--modal-button-hover-bg);
    }
    .increase-score-content input[type="number"],
    .start-game-content input[type="number"],
    .start-game-content select,
    .manage-team-content select {
      width: 100%;
      margin-bottom: 0;
      text-align: center;
      font-size: clamp(1.3rem,4.5vw,1.8rem);
      padding: 6px;
    }
    .start-game-content .input-group,
    .manage-team-content .input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 48%;
      gap: 5px;
    }
    .start-game-content .input-row,
    .manage-team-content .input-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      gap: 10px;
    }
    .start-game-content label,
    .manage-team-content label {
      display: block;
      margin-bottom: 0;
      font-size: clamp(.8rem,2.8vw,1rem);
      text-align: center;
    }
    .scoreboard-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,.7);
      z-index: 50;
      display: block;
      opacity: 1;
      transition: opacity .5s ease-in-out;
    }
    .scoreboard-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .super-victory-modal {
      background: linear-gradient(45deg,#FFD700,#FFA500,#FF4500);
      animation: gradientAnimation 5s ease infinite alternate;
      color: #fff;
      text-shadow: 3px 3px 6px rgba(0,0,0,.6);
      font-weight: bold;
      z-index: 4000;
    }
    .super-victory-content {
      background-color: rgba(0,0,0,.7);
      color: #fff;
      padding: clamp(20px,7vw,40px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      animation: modalPopIn .5s ease-out forwards;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      gap: 15px;
    }
    .super-victory-content h3 {
      font-size: clamp(2.2rem,7vw,3.5rem);
      margin-bottom: 0;
      text-transform: uppercase;
      letter-spacing: clamp(1px,.8vw,4px);
    }
    .super-victory-content p {
      font-size: clamp(1.2rem,4vw,2rem);
      margin-bottom: 0;
    }
    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    @keyframes modalPopIn {
      from { transform: translateY(-50px) scale(.8); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    @media (orientation: landscape) {
      .modal-buttons {
        flex-direction: row;
      }
      .start-game-content .input-row,
      .manage-team-content .input-row {
        flex-direction: row;
      }
      .start-game-content > div,
      .manage-team-content > div {
        flex-direction: column;
      }
      .start-game-content .modal-buttons,
      .manage-team-content .modal-buttons {
        flex-basis: 100%;
        flex-direction: row;
        justify-content: space-evenly;
      }
    }
    .teams-display-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
      justify-content: space-between;
    }
    .team-card {
      background: linear-gradient(145deg,var(--card-bg-color),var(--collapsible-header-bg));
      border-radius: 15px;
      padding: 25px;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 10px 25px rgba(0,0,0,.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      border: none;
      position: relative;
      overflow: hidden;
      transition: transform .3s ease, box-shadow .3s ease;
      cursor: default;
    }
    .team-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 10px;
      height: 100%;
      background-color: var(--team-card-dynamic-border-color,var(--accent-color));
      transition: background-color .3s ease;
    }
    .team-card h4 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5rem;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 0;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,.4);
    }
    .team-card .team-color-indicator {
      display: none;
    }
    .team-card .player-list-compact {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 1.1rem;
      color: var(--text-color);
      text-align: center;
      width: 100%;
    }
    .team-card .player-list-compact li {
      background: none;
      padding: 6px 0;
      margin-bottom: 4px;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-bottom: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.9);
    }
    .team-card .player-list-compact li:last-child {
      border-bottom: none;
    }
    @media (min-width: 600px) {
      .team-card {
        min-width: calc(50% - 10px);
      }
    }
    @media (min-width: 900px) {
      .team-card {
        width: calc(33.33% - 10px);
      }
      }
    .swap-teams-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background-color: var(--gear-button-bg);
      color: var(--text-color);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,.3);
      z-index: 100;
      transition: background-color .3s ease, transform .3s ease, opacity .3s ease;
      opacity: 0;
      pointer-events: none;
    }
    .swap-teams-button.show {
      opacity: 1;
      pointer-events: auto;
    }
    .swap-teams-button:hover,
    .swap-teams-button:active {
      background-color: var(--neutral-hover-bg);
      transform: translate(-50%,-50%) scale(1.05);
    }
    @keyframes fadeOutAndShrink {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(.8); }
    }
    @keyframes fadeInAndGrow {
      0% { opacity: 0; transform: scale(.8); }
      100% { transform: scale(1); opacity: 1; }
    }
    .team-section.fade-out {
      animation: fadeOutAndShrink .3s ease-out forwards;
    }
    .team-section.fade-in {
      animation: fadeInAndGrow .3s ease-out forwards;
    }
    .game-timer {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--text-color);
      text-shadow: 2px 2px 4px rgba(0,0,0,.6);
      background-color: rgba(0,0,0,.6);
      padding: 10px 20px;
      border-radius: 10px 10px 0 0;
      z-index: 100;
      opacity: 0;
      transition: opacity .3s ease-in-out, background-color .3s ease;
      display: flex;
      flex-direction: column; /* Alterado para coluna para empilhar os timers */
      align-items: center;
      justify-content: center;
      gap: 5px; /* Espaçamento entre os timers */
      width: auto;
      min-width: 150px;
      cursor: pointer; /* Adicionado para indicar que é clicável */
    }
    .game-timer.show {
      opacity: 1;
    }
    .game-timer i {
      font-size: 1.5rem; /* Tamanho do ícone */
    }
    .game-timer .timer-main {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .game-timer .timer-set {
        font-size: 1.2rem; /* Tamanho menor para o cronômetro do set */
        color: rgba(255, 255, 255, 0.8); /* Cor mais suave para o set timer */
        text-shadow: 1px 1px 2px rgba(0,0,0,.4);
    }
    /* Estilos para a nova seção de Agendamentos */
    #agendamentos .input-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap; /* Permite que os inputs quebrem a linha em telas menores */
    }
    #agendamentos .input-group {
      flex: 1; /* Permite que os grupos de input cresçam e ocupem o espaço */
      min-width: 120px; /* Garante que não fiquem muito pequenos */
      margin-bottom: 0; /* Removido para evitar espaçamento duplo com input-row */
    }
    #agendamentos .input-group label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block; /* Garante que o label ocupe sua própria linha */
    }
    #agendamentos ul {
      display: flex;
      flex-wrap: wrap;
      gap: 15px; /* Espaçamento entre os cartões */
      padding: 0;
    }
    #agendamentos ul li {
      background: none; /* Removido background do li, pois o cartão terá o seu */
      padding: 0;
      margin-bottom: 0; /* Removido para evitar espaçamento duplo com gap */
      border-radius: 0;
      display: block; /* Para que o cartão seja o único item do li */
      width: 100%; /* Ocupa a largura total por padrão */
      max-width: 400px; /* Limita a largura máxima do cartão */
    }

    /* Estilos para os Cartões de Agendamento */
    .appointment-card {
        background-color: var(--appointment-card-bg);
        border-radius: 10px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        position: relative; /* Para posicionar o botão de exclusão */
        border: 1px solid var(--appointment-card-border);
        height: 100%; /* Garante que o cartão preencha o li */
    }

    .appointment-card.appointment-past {
        opacity: 0.8; /* Jogos passados um pouco mais opacos */
        background-color: var(--appointment-card-past-bg);
        border-color: var(--accent-color); /* Past items get a more neutral border */
    }

    .appointment-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
    }

    .appointment-card .card-header span {
        font-weight: bold;
        color: var(--text-color);
        display: flex;
        align-items: center;
        font-size: 0.95em; /* Ajuste para caber melhor */
    }

    .appointment-card .card-header i {
        margin-right: 8px;
        color: var(--appointment-icon-color); /* Usando a nova variável para a cor do ícone */
    }

    .appointment-card .card-body {
        flex-grow: 1; /* Permite que o corpo ocupe o espaço restante */
    }

    .appointment-card p {
        margin: 5px 0;
        color: var(--text-color);
        display: flex; /* Para alinhar ícone com texto */
        align-items: center; /* Para alinhar ícone com texto */
    }

    .appointment-card p i {
        margin-right: 8px;
        color: var(--appointment-icon-color); /* Usando a nova variável para a cor do ícone */
    }

    .delete-appointment-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: rgba(255, 0, 0, 0.7); /* Vermelho para exclusão */
        font-size: 1.2em;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.3s ease;
    }

    .delete-appointment-btn:hover {
        background-color: rgba(255, 0, 0, 0.1);
        color: red;
    }

    /* Media query para telas maiores */
    @media (min-width: 600px) {
        #agendamentos ul li {
            width: calc(50% - 10px); /* Dois cartões por linha com espaçamento */
        }
    }

    @media (min-width: 900px) {
        #agendamentos ul li {
            width: calc(33.33% - 10px); /* Três cartões por linha */
        }
    }

    /* Estilos para a tela de login */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-bg); /* Use modal background for consistency */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5000; /* Ensure it's on top of everything */
      flex-direction: column;
      gap: 20px;
    }

    .login-content {
      background-color: var(--modal-content-bg);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,.3);
      color: var(--modal-text-color);
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--modal-button-bg);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto 0;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-content">
      <p id="loginMessage">Carregando...</p>
      <div class="spinner"></div>
    </div>
  </div>

  <div id="appContent" style="display: none;">
    <button class="gear-button" onclick="toggleMenu()">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div class="overlay" id="menuOverlay"></div>
    <div class="menu" id="gearMenu">
      <button onclick="navigateTo('pontuacao')"><i class="fa-solid fa-medal" style="margin-right:.5rem;"></i>Pontuação</button>
      <button onclick="navigateTo('times')"><i class="fa-solid fa-shuffle" style="margin-right:.5rem;"></i>Times</button>
      <button onclick="navigateTo('jogadores')"><i class="fa-solid fa-users" style="margin-right:.5rem;"></i>Jogadores</button>
      <button onclick="navigateTo('agendamentos')"><i class="fa-solid fa-calendar-alt" style="margin-right:.5rem;"></i>Agendamentos</button>
      <button onclick="navigateTo('configuracoes')"><i class="fa-solid fa-gear" style="margin-right:.5rem;"></i>Configurações</button>
      <button id="resetGameButton" class="disabled" onclick="confirmReset()"><i class="fa-solid fa-rotate-right" style="margin-right:.5rem;"></i>Reiniciar Partida</button>
    </div>
    <div id="pontuacao" class="section active">
      <div class="scoreboard-overlay" id="scoreboardOverlay"></div>
      <div class="scoreboard">
        <div class="team-section" id="sectionA">
          <div class="victory-elements">
            <div class="crown-container">
              <i class="fa-solid fa-crown crown-icon"></i>
            </div>
            <div class="confetti-container"></div>
          </div>
          <div class="set-indicators left" id="setIndicatorA"></div>
          <div class="team-name" id="teamNameA"></div>
          <div class="player-info-container top-left">
            <ul class="player-list" id="playerListA"></ul>
          </div>
          <div class="score" id="scoreA">0</div>
        </div>
        <div class="team-section" id="sectionB">
          <div class="victory-elements">
            <div class="crown-container">
              <i class="fa-solid fa-crown crown-icon"></i>
            </div>
            <div class="confetti-container"></div>
          </div>
          <div class="set-indicators right" id="setIndicatorB"></div>
          <div class="team-name" id="teamNameB"></div>
          <div class="player-info-container top-left">
            <ul class="player-list" id="playerListB"></ul>
          </div>
          <div class="score" id="scoreB">0</div>
        </div>
      </div>
      <button class="btn start-game-button" id="startGameButton" onclick="showStartGameModal()">Iniciar Partida</button>
      <button class="swap-teams-button" id="swapTeamsButton" onclick="swapTeams()">
        <i class="fa-solid fa-right-left"></i>
      </button>
      <div class="game-timer" id="gameTimer" onclick="toggleTimer()">
        <div class="timer-main">
          <span id="timerDisplay">00:00</span>
          <i id="timerIcon" class="fa-solid fa-play"></i>
        </div>
        <div class="timer-set">
          Set: <span id="setTimerDisplay">00:00</span>
        </div>
      </div>
    </div>
    <div id="times" class="section">
      <h2 style="margin: 0px 0px 10px 0px;">Gerar Times</h2>
      <span class="adicionar">
        <button class="btn" onclick="generateCustomTeams()" style="width: 100%;">Gerar</button>
      </span>    
      <div class="teams-display-container" id="teamsContainer"></div>
    </div>
    <div id="jogadores" class="section">
      <h2>Jogadores</h2>
      <span class="adicionar">
        <input type="text" id="playerName" placeholder="Nome do jogador" />
        <button class="btn" onclick="addPlayer()">Adicionar</button>
      </span>
      <span style="display:flex;flex-direction:row-reverse;justify-content:space-between;">
        <div id="playerCounter">0/0</div>
        <div style="display:flex;gap:1rem;margin-bottom:1rem;">
          <button class="btn" id="toggleSelectAllButton" onclick="toggleSelectAllPlayers()">Alternar Seleção</button>
        </div>
      </span>
      <ul id="playerList"></ul>
    </div>
    <div id="agendamentos" class="section">
      <h2 style="margin-bottom:10px;">Agendamentos de Jogos</h2>

      <div class="input-row">
        <div class="input-group">
          <label for="gameDate">Data:</label>
          <input type="date" id="gameDate">
        </div>
        <div class="input-group">
          <label for="gameTime">Hora:</label>
          <input type="time" id="gameTime">
        </div>
      </div>
      <div class="input-row">
        <div class="input-group" style="flex: 100%;"> <label for="gameLocation">Local:</label>
          <input type="text" id="gameLocation" placeholder="Ex: Praia, Ginásio X">
        </div>
      </div>
      <button class="btn" onclick="addAppointment()">Adicionar Agendamento</button>

      <h3 style="margin: 20px 0px 10px 0px;">Próximos Jogos</h3>
      <ul id="upcomingAppointmentsList"></ul>

      <div class="collapsible-container">
          <div class="collapsible-header" onclick="togglePastAppointmentsSection()">
              <h3>Jogos Anteriores</h3>
              <i class="fa-solid fa-chevron-right collapsible-arrow" id="pastAppointmentsArrow"></i>
          </div>
          <div class="collapsible-content" id="pastAppointmentsContent">
              <ul id="pastAppointmentsList"></ul>
          </div>
      </div>
    </div>
    <div id="configuracoes" class="section">
      <h2 style="margin-bottom:20px;">Configurações</h2>
      <div class="collapsible-container">
          <div class="collapsible-header" onclick="toggleGeneralSettingsSection()">
              <h3>Geral</h3>
              <i class="fa-solid fa-chevron-right collapsible-arrow" id="generalSettingsArrow"></i>
          </div>
          <div class="collapsible-content" id="generalSettingsContent">
            <div class="config-group">
              <label for="playersPerTeam">Jogadores por time:</label>
              <input type="number" id="playersPerTeam" min="1" value="4" onchange="saveSettings()">
            </div>
            <div class="config-group">
              <label for="winningScore">Pontos para Vencer (Set):</label>
              <input type="number" id="winningScore" min="1" value="15" onchange="saveSettings()">
            </div>
            <div class="config-group">
              <label for="setsToWinConfig">Número de Sets para Vencer a Partida (0 para ilimitado):</label>
              <input type="number" id="setsToWinConfig" min="0" value="0" onchange="saveSettings()">
            </div>
            <div class="config-group">
              <label for="themeSelect">Tema:</label>
              <select id="themeSelect" onchange="setTheme(this.value)">
                <option value="dark">Escuro</option>
                <option value="light">Claro</option>
              </select>
            </div>
            <span style="display:flex;">
              <div class="checkbox-group">
                <label for="vibrationEnabled">Vibração ao Pontuar:</label>
                <input type="checkbox" id="vibrationEnabled" onchange="saveSettings()">
              </div>
              <div class="checkbox-group" style="margin-left:20px;">
                <label for="showPlayersOnScoreboard">Exibir Jogadores no Placar:</label>
                <input type="checkbox" id="showPlayersOnScoreboard" onchange="saveSettings()">
              </div>
            </span>
          </div>
      </div>
      <div class="collapsible-container">
          <div class="collapsible-header" onclick="toggleCustomTeamNamesSection()">
              <h3>Times Personalizados</h3> <i class="fa-solid fa-chevron-right collapsible-arrow" id="customTeamNamesArrow"></i>
          </div>
          <div class="collapsible-content" id="customTeamNamesContent">
              <p style="font-size:.9em;color:var(--text-color);opacity:.8;margin-bottom:.5rem;">Defina nomes e cores para seus times favoritos. Eles aparecerão nas opções de seleção e ao gerar times.</p>
              <div class="config-group color-picker-group">
                  <label for="customTeamName1">Time 1:</label>
                  <input type="text" id="customTeamName1" value="" onchange="saveSettings()" style="flex:1;">
                  <input type="color" id="customTeamColor1" value="#007bff" onchange="saveSettings()">
              </div>
              <div class="config-group color-picker-group">
                  <label for="customTeamName2">Time 2:</label>
                  <input type="text" id="customTeamName2" value="" onchange="saveSettings()" style="flex:1;">
                  <input type="color" id="customTeamColor2" value="#dc3545" onchange="saveSettings()">
              </div>
              <div class="config-group color-picker-group">
                  <label for="customTeamName3">Time 3:</label>
                  <input type="text" id="customTeamName3" value="" onchange="saveSettings()" style="flex:1;">
                  <input type="color" id="customTeamColor3" value="#28a745" onchange="saveSettings()">
              </div>
              <div class="config-group color-picker-group">
                  <label for="customTeamName4">Time 4:</label>
                  <input type="text" id="customTeamName4" value="" onchange="saveSettings()" style="flex:1;">
                  <input type="color" id="customTeamColor4" value="#ffc107" onchange="saveSettings()">
              </div>
              <div class="config-group color-picker-group">
                  <label for="customTeamName5">Time 5:</label>
                  <input type="text" id="customTeamName5" value="" onchange="saveSettings()" style="flex:1;">
                  <input type="color" id="customTeamColor5" value="#6f42c1" onchange="saveSettings()">
              </div>
          </div>
      </div>
      <div class="collapsible-container">
          <div class="collapsible-header" onclick="toggleDataManagementSection()">
              <h3>Gerenciamento de Dados</h3> <i class="fa-solid fa-chevron-right collapsible-arrow" id="dataManagementArrow"></i>
          </div>
          <div class="collapsible-content" id="dataManagementContent">
              <div class="config-group">
                  <label>Exportar Dados:</label>
                  <button class="btn" onclick="exportSettings()">Exportar Configurações</button>
              </div>
              <div class="config-group">
                  <label>Importar Dados:</label>
                  <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="importSettings(event)">
                  <button class="btn" onclick="document.getElementById('importFileInput').click()">Importar Configurações</button>
              </div>
              <div class="config-group">
                  <label>Resetar Tudo:</label>
                  <button class="btn" onclick="confirmResetAllData()" style="background-color: #dc3545;">Resetar Todos os Dados</button>
              </div>
          </div>
      </div>
      <div class="config-group" style="margin-top: 20px; text-align: center; padding: 15px; border-radius: 10px; background-color: var(--setting-section-bg); border: 1px solid var(--setting-item-border);">
          <label style="font-size: 1.1em; margin-bottom: 5px; color: var(--text-color);">Versão do Sistema:</label>
          <span id="systemVersionDisplay" style="font-weight: bold; font-size: 1.2em; color: var(--text-color);">Carregando...</span>
      </div>
      <div class="config-group" style="margin-top: 10px; text-align: center; padding: 15px; border-radius: 10px; background-color: var(--setting-section-bg); border: 1px solid var(--setting-item-border);">
          <label style="font-size: 1.1em; margin-bottom: 5px; color: var(--text-color);">Seu ID de Usuário:</label>
          <span id="userIdDisplay" style="font-weight: bold; font-size: 0.9em; word-break: break-all; color: var(--text-color);">Carregando...</span>
      </div>
    </div>
    <div id="gameOverModal" class="game-over-modal">
      <div class="modal-content">
        <h3 id="modalWinningTeamName"></h3>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
          <button onclick="startNewGame()">Novo Jogo</button>
          <button id="newSetButton" onclick="startNewSet()">Novo Set</button>
          <button onclick="increaseWinningScoreModal()">Continuar partida</button>
        </div>
      </div>
    </div>
    <div id="increaseScoreModal" class="increase-score-modal">
      <div class="increase-score-content">
        <h3>Aumentar Pontuação</h3>
        <p>Defina o novo valor para a pontuação de vitória do set:</p>
        <input type="number" id="newWinningScoreInput" min="1" value="15">
        <div class="modal-buttons">
          <button onclick="confirmIncreaseWinningScore()">Confirmar</button>
          <button onclick="hideIncreaseScoreModal()">Cancelar</button>
        </div>
      </div>
    </div>
    <div id="startGameModal" class="start-game-modal">
      <div class="start-game-content">
        <h3>Iniciar Nova Partida</h3>
        <p>Defina as configurações da partida:</p>
        <div class="input-row">
          <div class="input-group">
            <label for="initialWinningScore">Pontos por set:</label>
            <input type="number" id="initialWinningScore" min="1" value="15">
          </div>
          <div class="input-group">
            <label for="initialNumberOfSets">Número de sets:</label>
            <input type="number" id="initialNumberOfSets" min="0" value="0">
          </div>
        </div>
        <div class="modal-buttons">
          <button id="modalStartGameButton" onclick="confirmStartGame()">Iniciar Partida</button>
          <button onclick="hideStartGameModal()" style="background-color:#dc3545;--modal-button-hover-bg:#c82333;">Cancelar</button>
        </div>
      </div>
    </div>
    <div id="superVictoryModal" class="super-victory-modal">
      <div class="super-victory-content">
        <h3 id="superVictoryTeamName"></h3>
        <p>VENCEU A PARTIDA!</p>
        <div class="confetti-container" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
      </div>
    </div>
    <div id="manageTeamModal" class="manage-team-modal">
      <div class="modal-content manage-team-content">
        <h3 id="manageTeamModalTitle">Selecionar Time</h3>
        <div class="input-group" style="width:100%;">
          <label for="selectTeamForManagement">Selecione um time:</label>
          <select id="selectTeamForManagement" onchange="saveTeamNameAndPlayers()"></select>
        </div>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    const DEFAULT_CUSTOM_TEAM_COLORS = ["#007bff", "#dc3545", "#28a745", "#ffc107", "#6f42c1"];
    // Variáveis de estado globais para jogadores, agora gerenciadas pelo Firestore
    let allPlayers = []; // Armazenará os objetos de jogador do Firestore
    let generatedTeams = []; 
    let winningScore;
    let setsToWin;
    let playersPerTeam; 
    let customTeamNames;
    let currentTheme;
    let vibrationEnabled;
    let showPlayersOnScoreboard;
    let scoreA = 0, scoreB = 0;
    let setsA = 0, setsB = 0;
    let gameEnded = false;
    let gameStarted = false; 
    let lastWinningTeam = null;
    let currentPlayingTeamA = { name: 'Time A', players: [], color: '#007bff' };
    let currentPlayingTeamB = { name: 'Time B', players: [], color: '#dc3545' };
    let activeManageTeamId = null;
    let gameTimerInterval = null; // Renomeado para clareza
    let setTimerInterval = null; // Novo cronômetro para o set
    let gameTimeInSeconds = 0;
    let setTimeInSeconds = 0; // Novo contador de tempo para o set
    let isTimerRunning = false; // Variável para controlar o estado do cronômetro

    // Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBeu7H2Us7FYNb0yhGx8pkYj_aeTgnndUA",
      authDomain: "voleizinho-das-ruas.firebaseapp.com",
      databaseURL: "https://voleizinho-das-das-ruas-default-rtdb.firebaseio.com",
      projectId: "voleizinho-das-ruas",
      storageBucket: "voleizinho-das-ruas.firebasestorage.app",
      messagingSenderId: "394754605937",
      appId: "1:394754605937:web:e97314f6c48373c8dc2cd0"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let userId = null; // Variável para armazenar o ID do usuário autenticado

    // New elements for login UI
    let loginOverlay;
    let loginMessage;
    let appContent;

    // Autenticação para acessar o Firestore
    const authenticateUser = async () => {
        console.log("Attempting authentication...");
        loginOverlay.style.display = 'flex'; // Garante que a tela de carregamento esteja visível
        loginMessage.textContent = "Verificando autenticação...";

        // Use o token de autenticação fornecido pelo ambiente Canvas
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        try {
            if (initialAuthToken) {
                // Tenta fazer login com o token personalizado
                const userCredential = await auth.signInWithCustomToken(initialAuthToken);
                userId = userCredential.user.uid;
                document.getElementById('userIdDisplay').textContent = userId + ' (Autenticado)';
                console.log("Login com token personalizado bem-sucedido. UID:", userId);
            } else {
                // Se não houver token, tenta o login anônimo (fallback)
                const userCredential = await auth.signInAnonymously();
                userId = userCredential.user.uid;
                document.getElementById('userIdDisplay').textContent = userId + ' (Anônimo)';
                console.log("Login anônimo bem-sucedido. UID:", userId);
            }

            // Após o login, esconde a tela de carregamento e mostra o conteúdo do app
            loginOverlay.style.display = 'none';
            appContent.style.display = 'block';
            listenForAppointments();
            listenForPlayers();

        } catch (error) {
            console.error("Erro na autenticação:", error);
            loginMessage.textContent = `Erro na autenticação: ${error.message}. Recarregue a página.`;
            displayMessage(`Erro na autenticação: ${error.message}`, "error");
            // Em caso de erro, garante que o app não seja exibido e as listas sejam limpas
            appContent.style.display = 'none';
            renderAppointments([]);
            renderPlayerList([]);
        }
    };

    function toggleMenu() {
      const menu = document.getElementById("gearMenu");
      const overlay = document.getElementById("menuOverlay");
      menu.classList.toggle("show");
      overlay.classList.toggle("show");
      updateResetButtonVisibility();
      if (menu.classList.contains("show")) {
        document.addEventListener('click', closeMenuOnOutsideClick);
      } else {
        document.removeEventListener('click', closeMenuOnOutsideClick);
      }
    }

    function closeMenuOnOutsideClick(e) {
      const menu = document.getElementById("gearMenu");
      const button = document.querySelector(".gear-button");
      if (!menu.contains(e.target) && !button.contains(e.target)) {
        if (menu.classList.contains("show")) {
            menu.classList.remove("show");
            document.getElementById("menuOverlay").classList.remove("show");
            document.removeEventListener('click', closeMenuOnOutsideClick);
        }
      }
    }

    function navigateTo(id) {
      showSection(id);
      document.getElementById("gearMenu").classList.remove("show");
      document.getElementById("menuOverlay").classList.remove("show");
      updateResetButtonVisibility();
      if (id === 'times') {
          renderGeneratedTeams();
      } else if (id === 'agendamentos') {
          // A renderização de agendamentos é feita pelo listener do Firestore (onSnapshot)
      } else if (id === 'jogadores') {
          // A renderização de jogadores é feita pelo listener do Firestore (onSnapshot)
      }
    }

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      updateResetButtonVisibility();
    }

    function updateResetButtonVisibility() {
        const resetButton = document.getElementById('resetGameButton');
        const pontuacaoSection = document.getElementById('pontuacao');
        if (gameStarted && pontuacaoSection.classList.contains('active')) {
            resetButton.classList.remove('disabled');
        } else {
            resetButton.classList.add('disabled');
        }
    }

    async function addPlayer() {
        if (!userId) {
            displayMessage("Por favor, aguarde a autenticação ou faça login para adicionar jogadores.", "warning");
            return;
        }
        const input = document.getElementById("playerName");
        const name = input.value.trim();

        if (name) {
            const playerExists = allPlayers.some(p => p.name.toLowerCase() === name.toLowerCase());
            if (playerExists) {
                displayMessage("Este nome já está na lista.", "warning");
                return;
            }

            try {
                await db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/players`).add({
                    name: name,
                    isChecked: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = "";
                displayMessage("Jogador adicionado com sucesso!", "success");
            } catch (error) {
                console.error("Erro ao adicionar jogador:", error);
                displayMessage(`Erro ao adicionar jogador: ${error.message}`, "error");
            }
        }
    }

    function renderPlayerList(playersToRender) {
      playersToRender.sort((a, b) => a.name.localeCompare(b.name, 'pt', { sensitivity: 'base' }));
      allPlayers = playersToRender;

      const list = document.getElementById("playerList");
      list.innerHTML = "";
      allPlayers.forEach((player) => {
        const li = document.createElement("li");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = player.isChecked !== false;
        checkbox.style.marginRight = '.5rem';
        checkbox.style.width = '1rem';
        checkbox.onchange = async () => {
          if (!userId) {
              displayMessage("Por favor, faça login para atualizar o estado do jogador.", "warning");
              checkbox.checked = !checkbox.checked; // Reverte a seleção visual
              return;
          }
          try {
            await db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/players`).doc(player.id).update({
              isChecked: checkbox.checked
            });
          } catch (error) {
            console.error("Erro ao atualizar estado do jogador:", error);
            displayMessage("Erro ao atualizar estado do jogador.", "error");
          }
          updatePlayerCounter();
          updateToggleSelectAllButtonText();
        };
        const span = document.createElement("span");
        span.textContent = player.name;
        const btn = document.createElement("button");
        btn.textContent = "Remover";
        btn.className = "btn";
        btn.onclick = () => {
            showConfirmationModal("Tem certeza que deseja remover este jogador?", async (confirmed) => {
                if (confirmed) {
                    await deletePlayerFromFirestore(player.id);
                }
            });
        };
        li.appendChild(checkbox);
        li.appendChild(span);
        li.appendChild(btn);
        list.appendChild(li);
      });
      updatePlayerCounter();
      updateToggleSelectAllButtonText();
    }

    function updatePlayerCounter() {
      const selected = allPlayers.filter(p => p.isChecked !== false).length;
      const total = allPlayers.length;
      document.getElementById("playerCounter").textContent = `${selected}/${total}`;
    }

    async function toggleSelectAllPlayers() {
        if (!userId) {
            displayMessage("Por favor, faça login para selecionar jogadores.", "warning");
            return;
        }
        if (allPlayers.length === 0) {
            displayMessage("Não há jogadores para selecionar/desselecionar.", "warning");
            return;
        }

        const allSelected = allPlayers.every(p => p.isChecked !== false);
        let confirmationMessage;
        let action;
        if (allSelected) {
            confirmationMessage = "Tem certeza que deseja desmarcar todos os jogadores?";
            action = false;
        } else {
            confirmationMessage = "Tem certeza que deseja selecionar todos os jogadores?";
            action = true;
        }

        showConfirmationModal(confirmationMessage, async (confirmed) => {
            if (confirmed) {
                const batch = db.batch();
                allPlayers.forEach(player => {
                    const playerDocRef = db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/players`).doc(player.id);
                    batch.update(playerDocRef, { isChecked: action });
                });
                try {
                    await batch.commit();
                    displayMessage("Estado de seleção dos jogadores atualizado!", "success");
                } catch (error) {
                    console.error("Erro ao atualizar todos os jogadores:", error);
                    displayMessage("Erro ao atualizar estado de seleção dos jogadores.", "error");
                }
            }
        });
    }

    function updateToggleSelectAllButtonText() {
      const toggleButton = document.getElementById('toggleSelectAllButton');
      if (toggleButton) {
        const allSelected = allPlayers.every(p => p.isChecked !== false);
        if (allSelected && allPlayers.length > 0) {
          toggleButton.textContent = "Desselecionar Todos";
        } else {
          toggleButton.textContent = "Selecionar Todos";
        }
      }
    }

    function confirmReset() {
        const resetButton = document.getElementById('resetGameButton');
        if (resetButton.classList.contains('disabled')) {
            return;
        }
        showConfirmationModal("Tem certeza que deseja reiniciar a pontuação? Isso irá zerar os pontos e sets de ambos os times.", (confirmed) => {
            if (confirmed) {
                resetGame();
                document.getElementById("gearMenu").classList.remove("show");
                document.getElementById("menuOverlay").classList.remove("show");
            }
        });
    }

    function resetGame() {
      scoreA = 0;
      scoreB = 0;
      setsA = 0;
      setsB = 0;
      gameEnded = false;
      gameStarted = false; 
      lastWinningTeam = null; 
      document.getElementById("scoreA").textContent = 0;
      document.getElementById("scoreB").textContent = 0;
      updateSetsDisplay();
      updateScoreboardTeamsDisplay();
      updateResetButtonVisibility();
      updateSwapTeamsButtonVisibility(); 
      showStartGameModal();
      generatedTeams = [];
      renderGeneratedTeams();
      stopAllTimers();
      gameTimeInSeconds = 0;
      setTimeInSeconds = 0;
      updateTimerDisplay();
      document.getElementById('gameTimer').classList.remove('show');
    }

    async function resetAllData() {
        showConfirmationModal("Tem certeza que deseja resetar TODOS os dados locais? Isso apagará times gerados e configurações salvas localmente. Seus jogadores e agendamentos no Firebase NÃO serão afetados.", (confirmed) => {
            if (confirmed) {
                localStorage.clear();
                location.reload();
            }
        });
    }

    function confirmResetAllData() {
        resetAllData();
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateCustomTeams() {
      const perTeam = parseInt(document.getElementById("playersPerTeam").value);

      if (isNaN(perTeam) || perTeam <= 0) {
        displayMessage("Informe um número válido de jogadores por time.", "error");
        return false;
      }
      const selectedPlayers = allPlayers.filter(p => p.isChecked !== false).map(p => p.name);
      if (selectedPlayers.length < 2) {
        displayMessage("Selecione pelo menos dois jogadores para gerar times.", "error");
        return false;
      }
      if (selectedPlayers.length < perTeam) {
          displayMessage(`Você precisa de pelo menos ${perTeam} jogadores selecionados para gerar um time.`, "error");
          return false;
      }
      shuffle(selectedPlayers);
      generatedTeams = [];
      let teamCount = 0;
      for (let i = 0; i < selectedPlayers.length; i += perTeam) {
        teamCount++;
        const customTeam = customTeamNames[teamCount - 1];
        const teamName = customTeam && customTeam.name.trim() !== "" ? customTeam.name : `Time ${teamCount}`;
        const teamColor = customTeam ? customTeam.color : DEFAULT_CUSTOM_TEAM_COLORS[teamCount - 1] || '#cccccc';
        generatedTeams.push({ name: teamName, players: selectedPlayers.slice(i, i + perTeam), color: teamColor });
      }
      renderGeneratedTeams();
      displayMessage(`${teamCount} time(s) gerado(s) com sucesso!`, "success");
      return true;
    }

    function renderGeneratedTeams() {
        const container = document.getElementById("teamsContainer");
        container.innerHTML = "";
        if (generatedTeams.length === 0) {
            const noTeamsMsg = document.createElement('p');
            noTeamsMsg.textContent = 'Nenhum time gerado ainda. Vá em "Jogadores", selecione-os e depois use o botão "Gerar".';
            noTeamsMsg.style.textAlign = 'center';
            noTeamsMsg.style.fontStyle = 'italic';
            noTeamsMsg.style.color = 'rgba(255,255,255,.7)';
            container.appendChild(noTeamsMsg);
            return;
        }
        generatedTeams.forEach((team) => {
            const teamCard = document.createElement("div");
            teamCard.classList.add("team-card");
            teamCard.style.setProperty('--team-card-dynamic-border-color', team.color);
            const teamNameEl = document.createElement("h4");
            teamNameEl.appendChild(document.createTextNode(team.name));
            teamCard.appendChild(teamNameEl);
            const playersList = document.createElement("ul");
            playersList.classList.add('player-list-compact');
            if (team.players.length === 0) {
                const playerLi = document.createElement("li");
                playerLi.textContent = "Sem jogadores";
                playerLi.style.fontStyle = 'italic';
                playerLi.style.color = 'rgba(255,255,255,.5)';
                playersList.appendChild(playerLi);
            } else {
                team.players.forEach(player => {
                    const playerLi = document.createElement("li");
                    playerLi.textContent = player;
                    playersList.appendChild(playerLi);
                });
            }
            teamCard.appendChild(playersList);
            container.appendChild(teamCard);
        });
    }

    function setupSwipeToDecrease(id, team) {
      const el = document.getElementById(id);
      let startY = null;
      el.addEventListener('touchstart', e => {
        const playerInfoContainer = el.querySelector('.player-info-container');
        if (playerInfoContainer && playerInfoContainer.contains(e.target)) {
            startY = null;
            return;
        }
        if (e.touches.length === 1) {
          startY = e.touches[0].clientY;
        }
      });
      el.addEventListener('touchend', e => {
        if (startY !== null && e.changedTouches.length === 1) {
          const endY = e.changedTouches[0].clientY;
          if (endY - startY > 30) {
            changeScore(team, -1);
          }
          startY = null;
        }
      });
    }

    function triggerVibration() {
      if (vibrationEnabled && navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    function changeScore(team, delta) {
      if (!gameStarted) {
        if (delta > 0) displayMessage("Inicie uma partida primeiro!", "warning");
        return;
      }
      if (gameEnded) return;
      const scoreElement = document.getElementById('score' + team);
      scoreElement.classList.remove('increase-anim', 'decrease-anim');
      void scoreElement.offsetWidth; 
      if (team === 'A') {
        scoreA = Math.max(0, scoreA + delta);
        scoreElement.textContent = scoreA;
      } else {
        scoreB = Math.max(0, scoreB + delta);
        scoreElement.textContent = scoreB;
      }
      if (delta > 0) {
        scoreElement.classList.add('increase-anim');
        triggerVibration();
      } else if (delta < 0) {
        scoreElement.classList.add('decrease-anim');
        triggerVibration();
      }
      checkWinCondition();
    }

    function checkWinCondition() {
      if (gameEnded) return;
      let winner = null;
      if (scoreA >= winningScore && scoreA - scoreB >= 2) {
        winner = 'A';
      } else if (scoreB >= winningScore && scoreB - scoreA >= 2) {
        winner = 'B';
      }
      if (winner) {
        gameEnded = true;
        lastWinningTeam = winner;
        stopAllTimers();
        const winningTeamName = winner === 'A' ? currentPlayingTeamA.name : currentPlayingTeamB.name;
        showVictoryAnimation(winner, winningTeamName);
        updateSwapTeamsButtonVisibility(); 
        setTimeout(() => {
          let currentSetsA = setsA;
          let currentSetsB = setsB;
          if (winner === 'A') {
            currentSetsA++;
          } else {
            currentSetsB++;
          }
          if (setsToWin > 0 && (currentSetsA >= setsToWin || currentSetsB >= setsToWin)) {
            showSuperVictoryAnimation(winningTeamName);
          } else {
            showGameOverModal(winningTeamName, 'set_won');
          }
        }, 3000);
      }
    }

    function showVictoryAnimation(teamId, winningTeamName) {
      const teamSection = document.getElementById('section' + teamId);
      const victoryElements = teamSection.querySelector('.victory-elements');
      const crownContainer = victoryElements.querySelector('.crown-container');
      const confettiContainer = victoryElements.querySelector('.confetti-container');
      confettiContainer.innerHTML = '';
      victoryElements.classList.add('show');
      crownContainer.style.opacity = 0;
      crownContainer.style.animation = 'none';
      void crownContainer.offsetWidth; 
      crownContainer.style.animation = 'crownAppear 1.5s ease-out forwards';
      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f', '#ffa500'];
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.classList.add('confetti-piece');
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = confetti.style.width;
        const startX = teamSection.offsetWidth / 2;
        const startY = teamSection.offsetHeight / 2;
        confetti.style.left = `${startX}px`;
        confetti.style.top = `${startY}px`;
        const endX = (Math.random() - .5) * teamSection.offsetWidth * 1.5;
        const endY = (Math.random() - .5) * teamSection.offsetHeight * 1.5;
        const rotateDeg = Math.random() * 720;
        const duration = Math.random() * 1.5 + 1.5;
        const delay = Math.random() * .5;
        confetti.style.setProperty('--confetti-end-x', `${endX}px`);
        confetti.style.setProperty('--confetti-end-y', `${endY}px`);
        confetti.style.setProperty('--confetti-rotate-deg', `${rotateDeg}deg`);
        confetti.style.animation = `confettiFall ${duration}s ease-out ${delay}s forwards`;
        confetti.style.opacity = 1;
        confettiContainer.appendChild(confetti);
        confetti.addEventListener('animationend', () => {
          confetti.remove();
        });
      }
      setTimeout(() => {
        victoryElements.classList.remove('show');
      }, 3000);
    }

    function showGameOverModal(winningTeamName, gameStatus) {
      const modal = document.getElementById('gameOverModal');
      const modalWinningTeamName = document.getElementById('modalWinningTeamName');
      const modalMessage = document.getElementById('modalMessage');
      const newSetButton = document.getElementById('newSetButton');
      modalWinningTeamName.textContent = winningTeamName;
      if (gameStatus === 'game_won') {
        modalMessage.textContent = 'Venceu a Partida!';
        newSetButton.style.display = 'none';
      } else {
        modalMessage.textContent = 'Venceu o Set!';
        newSetButton.style.display = 'block';
      }
      modal.classList.add('show');
    }

    function hideGameOverModal() {
      document.getElementById('gameOverModal').classList.remove('show');
    }

    function increaseWinningScoreModal() {
      hideGameOverModal();
      document.getElementById('increaseScoreModal').classList.add('show');
      document.getElementById('newWinningScoreInput').value = winningScore + 5;
    }

    function hideIncreaseScoreModal() {
      document.getElementById('increaseScoreModal').classList.remove('show');
    }

    function confirmIncreaseWinningScore() {
      const newScore = parseInt(document.getElementById('newWinningScoreInput').value);
      if (isNaN(newScore) || newScore <= 0) {
        displayMessage("Por favor, insira um número de pontos válido.", "error");
        return;
      }
      if (newScore <= winningScore) {
        displayMessage(`A nova pontuação (${newScore}) deve ser maior que a pontuação atual (${winningScore}).`, "warning");
        return;
      }
      winningScore = newScore;
      localStorage.setItem('winningScore', winningScore.toString());
      document.getElementById('winningScore').value = winningScore;
      displayMessage(`Pontuação para vencer aumentada para ${winningScore}!`, "success");
      hideIncreaseScoreModal();
      gameEnded = false;
      startAllTimers();
    }

    function showStartGameModal() {
      document.getElementById('startGameModal').classList.add('show');
      document.getElementById('initialWinningScore').value = winningScore;
      document.getElementById('initialNumberOfSets').value = setsToWin;
      document.getElementById('startGameButton').style.display = 'none';
    }

    function hideStartGameModal() {
      document.getElementById('startGameModal').classList.remove('show');
      if (!gameStarted) { 
          document.getElementById('startGameButton').style.display = 'block';
          document.getElementById('scoreboardOverlay').classList.remove('hidden');
      }
    }

    function confirmStartGame() {
      const newWinningScore = parseInt(document.getElementById('initialWinningScore').value);
      const newSetsToWin = parseInt(document.getElementById('initialNumberOfSets').value);
      if (isNaN(newWinningScore) || newWinningScore <= 0) {
        displayMessage("Por favor, insira um valor válido para 'Pontos por set'.", "error");
        return;
      }
      if (isNaN(newSetsToWin) || newSetsToWin < 0) {
        displayMessage("Por favor, insira um valor válido para 'Número de sets'.", "error");
        return;
      }
      winningScore = newWinningScore;
      setsToWin = newSetsToWin;
      localStorage.setItem('winningScore', winningScore.toString());
      localStorage.setItem('setsToWin', setsToWin.toString());
      
      hideStartGameModal();

      const selectedPlayersCount = allPlayers.filter(p => p.isChecked !== false).length;
      if (selectedPlayersCount === 0) {
          showConfirmationModal("Não há jogadores selecionados. Deseja gerar times automaticamente com o número de jogadores por time definido nas configurações?", (confirmed) => { 
              if (confirmed) {
                  const success = generateCustomTeams(); 
                  if (!success) {
                      displayMessage("Não foi possível gerar times automaticamente. Por favor, adicione mais jogadores ou gere os times manualmente.", "error");
                      document.getElementById('startGameButton').style.display = 'block';
                      document.getElementById('scoreboardOverlay').classList.remove('hidden');
                      return; 
                  }
                  selectAndInitializeTeams();
              } else {
                  showStartGameModal(); 
              }
          });
      } else {
          selectAndInitializeTeams();
      }
    }

    function selectAndInitializeTeams() {
      if (generatedTeams.length >= 2) {
          currentPlayingTeamA = { ...generatedTeams[0] };
          currentPlayingTeamB = { ...generatedTeams[1] };
      } else if (customTeamNames.length >= 2 && customTeamNames[0].name.trim() !== "" && customTeamNames[1].name.trim() !== "") {
          currentPlayingTeamA = { ...customTeamNames[0] };
          currentPlayingTeamB = { ...customTeamNames[1] };
      } else {
          currentPlayingTeamA = { name: 'Time A', players: [], color: '#007bff' };
          currentPlayingTeamB = { name: 'Time B', players: [], color: '#dc3545' };
      }

      initializeGameAndTeams(false);
    }

    function initializeGameAndTeams(teamsJustGenerated = false) {
      scoreA = 0;
      scoreB = 0;
      setsA = 0;
      setsB = 0;
      gameEnded = false;
      gameStarted = true; 
      lastWinningTeam = null;
      
      document.getElementById("scoreA").textContent = scoreA;
      document.getElementById("scoreB").textContent = scoreB;
      updateSetsDisplay();
      document.getElementById('startGameButton').style.display = 'none';
      document.getElementById('scoreboardOverlay').classList.add('hidden');
      updateScoreboardTeamsDisplay();
      updateResetButtonVisibility();
      updateSwapTeamsButtonVisibility();
      gameTimeInSeconds = 0;
      setTimeInSeconds = 0;
      startAllTimers();
    }

    function startNewGame() {
      hideGameOverModal();

      scoreA = 0;
      scoreB = 0;
      setsA = 0;
      setsB = 0;
      gameEnded = false;
      gameStarted = true;

      document.getElementById("scoreA").textContent = 0;
      document.getElementById("scoreB").textContent = 0;
      updateSetsDisplay();
      document.getElementById('scoreboardOverlay').classList.add('hidden');
      document.getElementById('startGameButton').style.display = 'none';

      let nextTeamA = { ...currentPlayingTeamA }; 
      let nextTeamB = { ...currentPlayingTeamB };

      if (lastWinningTeam !== null) { 
          const losingTeam = (lastWinningTeam === 'A' ? currentPlayingTeamB : currentPlayingTeamA);
          const winningTeam = (lastWinningTeam === 'A' ? currentPlayingTeamA : currentPlayingTeamB);

          const availableTeamsForSubstitution = generatedTeams.filter(team => {
              const teamIdentifier = JSON.stringify({ name: team.name, players: team.players });
              const winningTeamIdentifier = JSON.stringify({ name: winningTeam.name, players: winningTeam.players });
              const losingTeamIdentifier = JSON.stringify({ name: losingTeam.name, players: losingTeam.players });
              return teamIdentifier !== winningTeamIdentifier && teamIdentifier !== losingTeamIdentifier;
          });

          if (availableTeamsForSubstitution.length > 0) {
              const randomIndex = Math.floor(Math.random() * availableTeamsForSubstitution.length);
              const newTeam = availableTeamsForSubstitution[randomIndex];

              if (lastWinningTeam === 'A') { 
                  nextTeamB = { ...newTeam };
                  displayMessage(`Time ${losingTeam.name} foi substituído por ${newTeam.name} para a nova partida!`, "info");
              } else { 
                  nextTeamA = { ...newTeam };
                  displayMessage(`Time ${losingTeam.name} foi substituído por ${newTeam.name} para a nova partida!`, "info");
              }
          } else {
              displayMessage("Não há times disponíveis para substituição. Os times atuais continuarão na nova partida.", "info");
          }
      } else { 
          if (generatedTeams.length >= 2) {
              nextTeamA = { ...generatedTeams[0] };
              nextTeamB = { ...generatedTeams[1] };
          } else if (customTeamNames.length >= 2 && customTeamNames[0].name.trim() !== "" && customTeamNames[1].name.trim() !== "") {
              nextTeamA = { ...customTeamNames[0] };
              nextTeamB = { ...customTeamNames[1] };
          } else {
              nextTeamA = { name: 'Time A', players: [], color: '#007bff' };
              nextTeamB = { name: 'Time B', players: [], color: '#dc3545' };
          }
      }

      currentPlayingTeamA = nextTeamA;
      currentPlayingTeamB = nextTeamB;

      updateScoreboardTeamsDisplay();
      lastWinningTeam = null; 
      gameTimeInSeconds = 0;
      setTimeInSeconds = 0;
      startAllTimers();
    }

    function startNewSet() {
      hideGameOverModal();

      let winnerId = lastWinningTeam;

      if (winnerId === 'A') {
          setsA++;
      } else {
          setsB++;
      }

      scoreA = 0;
      scoreB = 0;
      gameEnded = false;
      document.getElementById("scoreA").textContent = 0;
      document.getElementById("scoreB").textContent = 0;
      updateSetsDisplay();

      updateScoreboardTeamsDisplay();
      updateSwapTeamsButtonVisibility(); 
      setTimeInSeconds = 0;
      startAllTimers();
    }

    function showSuperVictoryAnimation(winningTeamName) {
      const superVictoryModal = document.getElementById('superVictoryModal');
      const superVictoryTeamName = document.getElementById('superVictoryTeamName');
      const confettiContainer = superVictoryModal.querySelector('.confetti-container');
      superVictoryTeamName.textContent = winningTeamName;
      superVictoryModal.classList.add('show');
      confettiContainer.innerHTML = '';
      const colors = ['#FFD700', '#FFA500', '#FF4500', '#FFFFFF', '#007bff', '#dc3545'];
      for (let i = 0; i < 200; i++) {
        const confetti = document.createElement('div');
        confetti.classList.add('confetti-piece');
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 15 + 8}px`;
        confetti.style.height = confetti.style.width;
        const startX = Math.random() * window.innerWidth;
        const startY = -Math.random() * window.innerHeight;
        confetti.style.left = `${startX}px`;
        confetti.style.top = `${startY}px`;
        const endX = (Math.random() - .5) * window.innerWidth * 2;
        const endY = window.innerHeight + Math.random() * window.innerHeight;
        const rotateDeg = Math.random() * 1080;
        const duration = Math.random() * 2 + 3;
        const delay = Math.random() * 1;
        confetti.style.setProperty('--confetti-end-x', `${endX}px`);
        confetti.style.setProperty('--confetti-end-y', `${endY}px`);
        confetti.style.setProperty('--confetti-rotate-deg', `${rotateDeg}deg`);
        confetti.style.animation = `confettiFall ${duration}s ease-out ${delay}s forwards`;
        confetti.style.opacity = 1;
        confettiContainer.appendChild(confetti);
        confetti.addEventListener('animationend', () => {
          confetti.remove();
        });
      }
      setTimeout(() => {
        superVictoryModal.classList.remove('show');
        showGameOverModal(winningTeamName, 'game_won');
      }, 5000);
    }

    function updateSetsDisplay() {
      const setIndicatorA = document.getElementById('setIndicatorA');
      const setIndicatorB = document.getElementById('setIndicatorB');
      setIndicatorA.innerHTML = '';
      setIndicatorB.innerHTML = '';
      for (let i = 0; i < setsA; i++) {
        const star = document.createElement('i');
        star.classList.add('fa-solid', 'fa-star', 'set-star');
        setIndicatorA.appendChild(star);
      }
      for (let i = 0; i < setsB; i++) {
        const star = document.createElement('i');
        star.classList.add('fa-solid', 'fa-star', 'set-star');
        setIndicatorB.appendChild(star);
      }
    }

    function saveSettings() {
      winningScore = parseInt(document.getElementById('winningScore').value);
      setsToWin = parseInt(document.getElementById('setsToWinConfig').value);
      playersPerTeam = parseInt(document.getElementById('playersPerTeam').value); 
      vibrationEnabled = document.getElementById('vibrationEnabled').checked;
      showPlayersOnScoreboard = document.getElementById('showPlayersOnScoreboard').checked;
      if (isNaN(winningScore) || winningScore <= 0) {
        winningScore = 15;
        document.getElementById('winningScore').value = 15;
      }
      if (isNaN(setsToWin) || setsToWin < 0) {
        setsToWin = 0;
        document.getElementById('setsToWinConfig').value = 0;
      }
      if (isNaN(playersPerTeam) || playersPerTeam <= 0) { 
        playersPerTeam = 4;
        document.getElementById('playersPerTeam').value = 4;
      }
      for (let i = 0; i < 5; i++) {
        customTeamNames[i] = {
            name: document.getElementById(`customTeamName${i + 1}`).value.trim(),
            color: document.getElementById(`customTeamColor${i + 1}`).value
        };
      }
      localStorage.setItem('winningScore', winningScore.toString());
      localStorage.setItem('setsToWin', setsToWin.toString());
      localStorage.setItem('playersPerTeam', playersPerTeam.toString()); 
      localStorage.setItem('vibrationEnabled', JSON.stringify(vibrationEnabled));
      localStorage.setItem('showPlayersOnScoreboard', JSON.stringify(showPlayersOnScoreboard));
      localStorage.setItem('customTeamNames', JSON.stringify(customTeamNames));
      updatePlayerDisplayOnScoreboard();
      applyTeamColorsToScoreboard();
    }

    function setTheme(themeName, save = true) {
      if (themeName === 'light') {
        document.body.classList.add('light-theme');
      } else {
        document.body.classList.remove('light-theme');
      }
      currentTheme = themeName;
      if (save) {
        localStorage.setItem('theme', themeName);
        displayMessage('Tema alterado para ' + (themeName === 'dark' ? 'Escuro' : 'Claro') + '!', "info");
      }
    }

    function loadSettings() {
      winningScore = parseInt(localStorage.getItem('winningScore') || '15');
      setsToWin = parseInt(localStorage.getItem('setsToWin') || '0');
      playersPerTeam = parseInt(localStorage.getItem('playersPerTeam') || '4'); 
      vibrationEnabled = JSON.parse(localStorage.getItem('vibrationEnabled') || 'true');
      showPlayersOnScoreboard = JSON.parse(localStorage.getItem('showPlayersOnScoreboard') || 'true');
      currentTheme = localStorage.getItem('theme') || 'dark';

      generatedTeams = []; 

      customTeamNames = JSON.parse(localStorage.getItem('customTeamNames') || '[]').map((team, index) => ({
          name: team.name || "",
          color: team.color || DEFAULT_CUSTOM_TEAM_COLORS[index] || '#cccccc'
      }));
      while (customTeamNames.length < 5) {
          customTeamNames.push({ name: "", color: DEFAULT_CUSTOM_TEAM_COLORS[customTeamNames.length] || '#cccccc' });
      }

      document.getElementById('winningScore').value = winningScore;
      document.getElementById('setsToWinConfig').value = setsToWin;
      document.getElementById('playersPerTeam').value = playersPerTeam; 
      document.getElementById('vibrationEnabled').checked = vibrationEnabled;
      document.getElementById('showPlayersOnScoreboard').checked = showPlayersOnScoreboard;
      for (let i = 0; i < 5; i++) {
        document.getElementById(`customTeamName${i + 1}`).value = customTeamNames[i].name;
        document.getElementById(`customTeamColor${i + 1}`).value = customTeamNames[i].color;
      }
      document.getElementById('themeSelect').value = currentTheme;
      setTheme(currentTheme, false);
      updatePlayerDisplayOnScoreboard();
    }

    function applyTeamColorsToScoreboard() {
        document.getElementById('sectionA').style.backgroundColor = currentPlayingTeamA.color;
        document.getElementById('sectionB').style.backgroundColor = currentPlayingTeamB.color;
    }

    function setupSwipeBetweenSections() {
      let touchStartX = null;
      document.body.addEventListener('touchstart', e => {
        if (document.getElementById("gearMenu").classList.contains("show") ||
            document.getElementById("gameOverModal").classList.contains("show") ||
            document.getElementById("increaseScoreModal").classList.contains("show") ||
            document.getElementById("startGameModal").classList.contains("show") ||
            document.getElementById("superVictoryModal").classList.contains("show") ||
            document.getElementById("customMessageModal").classList.contains("show") || 
            document.getElementById("customConfirmationModal").classList.contains("show") || 
            document.getElementById("manageTeamModal").classList.contains("show") ||
            e.target.closest('#startGameButton') || e.target.closest('#swapTeamsButton') ||
            document.getElementById("loginOverlay").style.display === 'flex') { // Adicionado para ignorar swipes durante o login
            touchStartX = null;
            return;
        }
        const activeSection = document.querySelector('.section.active');
        if (activeSection && activeSection.scrollHeight > activeSection.clientHeight) {
            const touch = e.touches[0];
            const startY = touch.clientY;
            const scrollableElement = activeSection;

            let isScrollingVertically = false;

            const handleTouchMove = (moveEvent) => {
                const currentY = moveEvent.touches[0].clientY;
                const deltaY = currentY - startY;

                if (Math.abs(deltaY) > 5) {
                    isScrollingVertically = true;
                }

                if (isScrollingVertically && 
                    ((deltaY > 0 && scrollableElement.scrollTop === 0) || 
                     (deltaY < 0 && scrollableElement.scrollTop + scrollableElement.clientHeight >= scrollableElement.scrollHeight - 1))) {
                    moveEvent.preventDefault();
                }
            };

            const handleTouchEnd = () => {
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            };

            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
        }

        touchStartX = e.touches[0].clientX;
      });
      document.body.addEventListener('touchend', e => {
        if (touchStartX === null) return;
        const touchEndX = e.changedTouches[0].clientX;
        const dx = touchStartX - touchEndX;
        const threshold = 50;
        
        if (document.getElementById("gameOverModal").classList.contains("show") ||
            document.getElementById("increaseScoreModal").classList.contains("show") ||
            document.getElementById("startGameModal").classList.contains("show") ||
            document.getElementById("superVictoryModal").classList.contains("show") ||
            document.getElementById("customMessageModal").classList.contains("show") || 
            document.getElementById("customConfirmationModal").classList.contains("show") || 
            document.getElementById("manageTeamModal").classList.contains("show") ||
            e.target.closest('#startGameButton') || e.target.closest('#swapTeamsButton') ||
            document.getElementById("gearMenu").classList.contains("show") ||
            document.getElementById("loginOverlay").style.display === 'flex' // Adicionado para ignorar swipes durante o login
            ) {
            touchStartX = null;
            return;
        }

        const sections = ['pontuacao', 'times', 'jogadores', 'agendamentos', 'configuracoes'];
        const currentIndex = sections.findIndex(id => document.getElementById(id).classList.contains('active'));
        let nextIndex = currentIndex;

        if (dx > threshold) {
          nextIndex = (currentIndex + 1) % sections.length;
        } else if (dx < -threshold) {
          nextIndex = (currentIndex - 1 + sections.length) % sections.length;
        }
        
        if (nextIndex !== currentIndex) {
            showSection(sections[nextIndex]);
        }
        touchStartX = null;
      });
    }

    function swapTeams() {
      if (!gameStarted) {
        displayMessage("Inicie uma partida para inverter os times.", "warning");
        return;
      }
      const sectionA = document.getElementById('sectionA');
      const sectionB = document.getElementById('sectionB');
      sectionA.style.pointerEvents = 'none';
      sectionB.style.pointerEvents = 'none';
      document.getElementById('swapTeamsButton').style.pointerEvents = 'none';
      const animationDuration = 300;
      sectionA.classList.add('fade-out');
      sectionB.classList.add('fade-out');
      setTimeout(() => {
        let tempScore = scoreA;
        scoreA = scoreB;
        scoreB = tempScore;
        let tempSets = setsA;
        setsA = setsB;
        setsB = tempSets;
        let tempTeam = currentPlayingTeamA;
        currentPlayingTeamA = currentPlayingTeamB;
        currentPlayingTeamB = tempTeam;
        document.getElementById("scoreA").textContent = scoreA;
        document.getElementById("scoreB").textContent = scoreB;
        updateSetsDisplay();
        updateScoreboardTeamsDisplay();
        sectionA.classList.remove('fade-out');
        sectionB.classList.remove('fade-out');
        sectionA.classList.add('fade-in');
        sectionB.classList.add('fade-in');
        setTimeout(() => {
          sectionA.classList.remove('fade-in');
          sectionB.classList.remove('fade-in');
          sectionA.style.pointerEvents = 'auto';
          sectionB.style.pointerEvents = 'auto';
          document.getElementById('swapTeamsButton').style.pointerEvents = 'auto';
        }, animationDuration);
      }, animationDuration);
    }

    function updateSwapTeamsButtonVisibility() {
        const swapButton = document.getElementById('swapTeamsButton');
        if (gameStarted && !gameEnded) {
            swapButton.classList.add('show');
        } else {
            swapButton.classList.remove('show');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const customModalHTML = `
            <div id="customMessageModal" class="custom-message-modal">
                <div class="modal-content custom-message-content">
                    <h3 id="customMessageTitle"></h3>
                    <p id="customMessageText"></p>
                    <div class="modal-buttons">
                        <button onclick="hideCustomMessageModal()">OK</button>
                    </div>
                </div>
            </div>
            <div id="customConfirmationModal" class="custom-confirmation-modal">
                <div class="modal-content custom-confirmation-content">
                    <h3 id="customConfirmationTitle">Confirmação</h3>
                    <p id="customConfirmationText"></p>
                    <div class="modal-buttons">
                        <button id="confirmYesButton">Sim</button>
                        <button id="confirmNoButton" style="background-color:#dc3545;--modal-button-hover-bg:#c82333;">Não</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', customModalHTML);
        document.getElementById('confirmYesButton').addEventListener('click', () => {
            if (typeof window.currentConfirmationCallback === 'function') {
                window.currentConfirmationCallback(true);
            }
            hideCustomConfirmationModal();
        });
        document.getElementById('confirmNoButton').addEventListener('click', () => {
            if (typeof window.currentConfirmationCallback === 'function') {
                window.currentConfirmationCallback(false);
            }
            hideCustomConfirmationModal();
        });
    });

    function displayMessage(message, type = 'info') {
        const modal = document.getElementById('customMessageModal');
        const titleElement = document.getElementById('customMessageTitle');
        const textElement = document.getElementById('customMessageText');
        let title = '';
        switch (type) {
            case 'success': title = 'Sucesso!'; break;
            case 'error': title = 'Erro!'; break;
            case 'warning': title = 'Atenção!'; break;
            default: title = 'Informação'; break;
        }
        titleElement.textContent = title;
        textElement.textContent = message;
        modal.classList.add('show');
    }

    function hideCustomMessageModal() {
        document.getElementById('customMessageModal').classList.remove('show');
    }

    function showConfirmationModal(message, callback) {
        const modal = document.getElementById('customConfirmationModal');
        const textElement = document.getElementById('customConfirmationText');
        textElement.textContent = message;
        window.currentConfirmationCallback = callback;
        modal.classList.add('show');
    }

    function hideCustomConfirmationModal() {
        document.getElementById('customConfirmationModal').classList.remove('show');
        window.currentConfirmationCallback = null;
    }

    function showManageTeamModal(teamId) {
        activeManageTeamId = teamId;
        const modal = document.getElementById('manageTeamModal');
        const selectElement = document.getElementById('selectTeamForManagement');
        document.getElementById('manageTeamModalTitle').textContent = `Selecionar Time`;
        const currentTeam = (teamId === 'A' ? currentPlayingTeamA : currentPlayingTeamB);
        selectElement.innerHTML = '<option value="">Selecione um time</option>';
        if (generatedTeams.length === 0) {
            selectElement.innerHTML += '<option value="" disabled>Nenhum time gerado</option>';
        } else {
            generatedTeams.forEach((team, index) => {
                const option = document.createElement('option');
                option.value = `generated-${index}`;
                option.textContent = `${team.name}`;
                if (currentTeam.name === team.name && currentTeam.players.length === team.players.length && currentTeam.players.every((p, i) => p === team.players[i])) {
                  option.selected = true; 
                }
                selectElement.appendChild(option);
            });
        }
        
        const selectedValue = selectElement.value;
        const isCurrentTeamGenerated = selectedValue.startsWith('generated-');
        const currentTeamIndex = isCurrentTeamGenerated ? parseInt(selectedValue.split('-')[1]) : -1;

        if (currentTeamIndex === -1 || 
            (generatedTeams[currentTeamIndex].name !== currentTeam.name || 
             !generatedTeams[currentTeamIndex].players.every((p, i) => p === currentTeam.players[i])) ) {
              selectElement.value = ""; 
        }

        modal.classList.add('show');
        setTimeout(() => {
            document.addEventListener('click', closeManageTeamModalOnOutsideClick);
        }, 0);
    }

    function closeManageTeamModalOnOutsideClick(e) {
      const modal = document.getElementById("manageTeamModal");
      const modalContent = modal.querySelector(".modal-content");
      if (!modalContent.contains(e.target)) {
        hideManageTeamModal();
      }
    }

    function hideManageTeamModal() {
        document.getElementById('manageTeamModal').classList.remove('show');
        activeManageTeamId = null;
        document.removeEventListener('click', closeManageTeamModalOnOutsideClick);
    }

    function saveTeamNameAndPlayers() {
        const selectedDropdownValue = document.getElementById('selectTeamForManagement').value;
        let targetTeam = (activeManageTeamId === 'A' ? currentPlayingTeamA : currentPlayingTeamB);
        let otherTeam = (activeManageTeamId === 'A' ? currentPlayingTeamB : currentPlayingTeamA);
        let finalTeamName;
        let finalTeamPlayers;
        let finalTeamColor;

        if (selectedDropdownValue === "") {
            finalTeamName = (activeManageTeamId === 'A' ? 'Time A' : 'Time B');
            finalTeamPlayers = [];
            finalTeamColor = (activeManageTeamId === 'A' ? '#007bff' : '#dc3545');
        } else if (selectedDropdownValue.startsWith('generated-')) {
            const index = parseInt(selectedDropdownValue.split('-')[1]);
            const selectedGeneratedTeam = generatedTeams[index];
            
            if (otherTeam.name === selectedGeneratedTeam.name && 
                otherTeam.players.length === selectedGeneratedTeam.players.length && 
                otherTeam.players.every((p, i) => p === selectedGeneratedTeam.players[i])) {
                displayMessage("Este time gerado já está atribuído ao outro time. Por favor, selecione um time diferente.", "warning");
                document.getElementById('selectTeamForManagement').value = ""; 
                return;
            }
            finalTeamName = selectedGeneratedTeam.name;
            finalTeamPlayers = selectedGeneratedTeam.players;
            finalTeamColor = selectedGeneratedTeam.color;
        }
        
        targetTeam.name = finalTeamName;
        targetTeam.players = finalTeamPlayers;
        targetTeam.color = finalTeamColor;

        updateScoreboardTeamsDisplay();
        hideManageTeamModal();
    }

    function toggleCustomTeamNamesSection() {
        const content = document.getElementById('customTeamNamesContent');
        const arrow = document.getElementById('customTeamNamesArrow');
        content.classList.toggle('show');
        arrow.classList.toggle('rotated');
    }

    function toggleGeneralSettingsSection() {
        const content = document.getElementById('generalSettingsContent');
        const arrow = document.getElementById('generalSettingsArrow');
        content.classList.toggle('show');
        arrow.classList.toggle('rotated');
    }

    function toggleDataManagementSection() {
        const content = document.getElementById('dataManagementContent');
        const arrow = document.getElementById('dataManagementArrow');
        content.classList.toggle('show');
        arrow.classList.toggle('rotated');
    }

    function togglePastAppointmentsSection() {
        const content = document.getElementById('pastAppointmentsContent');
        const arrow = document.getElementById('pastAppointmentsArrow');
        content.classList.toggle('show');
        arrow.classList.toggle('rotated');
    }

    function updatePlayerDisplayOnScoreboard() {
        const playerInfoContainerA = document.querySelector('#sectionA .player-info-container');
        const playerInfoContainerB = document.querySelector('#sectionB .player-info-container');
        if (showPlayersOnScoreboard) {
            playerInfoContainerA.classList.remove('hidden-players');
            playerInfoContainerB.classList.remove('hidden-players');
        } else {
            playerInfoContainerA.classList.add('hidden-players');
            playerInfoContainerB.classList.add('hidden-players');
        }
    }

    function exportSettings() {
        const appStateToExport = {
            winningScore: winningScore,
            setsToWin: setsToWin,
            playersPerTeam: playersPerTeam, 
            customTeamNames: customTeamNames,
            currentTheme: currentTheme,
            vibrationEnabled: vibrationEnabled,
            showPlayersOnScoreboard: showPlayersOnScoreboard,
        };
        const dataStr = JSON.stringify(appStateToExport, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'placar_volei_config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        displayMessage("Configurações exportadas com sucesso!", "success");
    }

    function importSettings(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedAppState = JSON.parse(e.target.result);
                
                generatedTeams = []; 
                winningScore = importedAppState.winningScore || 15;
                setsToWin = importedAppState.setsToWin !== undefined ? importedAppState.setsToWin : 0;
                playersPerTeam = importedAppState.playersPerTeam !== undefined ? importedAppState.playersPerTeam : 4; 
                customTeamNames = importedAppState.customTeamNames || DEFAULT_CUSTOM_TEAM_COLORS.map((color, index) => ({ name: "", color }));
                currentTheme = importedAppState.currentTheme || 'dark';
                vibrationEnabled = importedAppState.vibrationEnabled !== undefined ? importedAppState.vibrationEnabled : true;
                showPlayersOnScoreboard = importedAppState.showPlayersOnScoreboard !== undefined ? importedAppState.showPlayersOnScoreboard : true;
                
                localStorage.setItem('winningScore', winningScore.toString());
                localStorage.setItem('setsToWin', setsToWin.toString());
                localStorage.setItem('playersPerTeam', playersPerTeam.toString()); 
                localStorage.setItem('customTeamNames', JSON.stringify(customTeamNames));
                localStorage.setItem('theme', currentTheme);
                localStorage.setItem('vibrationEnabled', JSON.stringify(vibrationEnabled));
                localStorage.setItem('showPlayersOnScoreboard', JSON.stringify(showPlayersOnScoreboard));

                scoreA = 0;
                scoreB = 0;
                setsA = 0;
                setsB = 0;
                gameEnded = false;
                gameStarted = false;
                lastWinningTeam = null;
                currentPlayingTeamA = { name: 'Time A', players: [], color: '#007bff' };
                currentPlayingTeamB = { name: 'Time B', players: [], color: '#dc3545' };

                document.getElementById('winningScore').value = winningScore;
                document.getElementById('setsToWinConfig').value = setsToWin;
                document.getElementById('playersPerTeam').value = playersPerTeam; 
                document.getElementById('vibrationEnabled').checked = vibrationEnabled;
                document.getElementById('showPlayersOnScoreboard').checked = showPlayersOnScoreboard;
                document.getElementById('themeSelect').value = currentTheme;
                setTheme(currentTheme, false);
                for (let i = 0; i < 5; i++) {
                    document.getElementById(`customTeamName${i + 1}`).value = customTeamNames[i].name;
                    document.getElementById(`customTeamColor${i + 1}`).value = customTeamNames[i].color;
                }
                updateSetsDisplay();
                document.getElementById("scoreA").textContent = scoreA; 
                document.getElementById("scoreB").textContent = scoreB; 
                updateScoreboardTeamsDisplay();
                updateSwapTeamsButtonVisibility();
                updateResetButtonVisibility(); 
                
                document.getElementById('startGameButton').style.display = 'block';
                document.getElementById('scoreboardOverlay').classList.remove('hidden');

                displayMessage("Configurações importadas com sucesso!", "success");
            } catch (error) {
                console.error("Erro ao importar configurações:", error);
                displayMessage("Erro ao importar arquivo. Verifique se é um arquivo de configurações válido.", "error");
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }

    function updateScoreboardTeamsDisplay() {
        document.getElementById('teamNameA').textContent = currentPlayingTeamA.name;
        document.getElementById('teamNameB').textContent = currentPlayingTeamB.name;
        
        const playerListA = document.getElementById('playerListA');
        const playerListB = document.getElementById('playerListB');
        playerListA.innerHTML = '';
        playerListB.innerHTML = '';

        currentPlayingTeamA.players.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p;
            playerListA.appendChild(li);
        });
        currentPlayingTeamB.players.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p;
            playerListB.appendChild(li);
        });
        updatePlayerDisplayOnScoreboard();
        applyTeamColorsToScoreboard();
    }

    function updateTimerDisplay() {
      const minutesGame = Math.floor(gameTimeInSeconds / 60);
      const secondsGame = gameTimeInSeconds % 60;
      const formattedGameTime = 
        `${minutesGame.toString().padStart(2, '0')}:${secondsGame.toString().padStart(2, '0')}`;
      document.getElementById('timerDisplay').textContent = formattedGameTime;

      const minutesSet = Math.floor(setTimeInSeconds / 60);
      const secondsSet = setTimeInSeconds % 60;
      const formattedSetTime = 
        `${minutesSet.toString().padStart(2, '0')}:${secondsSet.toString().padStart(2, '0')}`;
      document.getElementById('setTimerDisplay').textContent = formattedSetTime;

      const timerIcon = document.getElementById('timerIcon');
      if (isTimerRunning) {
          timerIcon.classList.remove('fa-play');
          timerIcon.classList.add('fa-pause');
      } else {
          timerIcon.classList.remove('fa-pause');
          timerIcon.classList.add('fa-play');
      }
    }

    function startAllTimers() {
      if (gameTimerInterval) {
        clearInterval(gameTimerInterval);
      }
      if (setTimerInterval) {
        clearInterval(setTimerInterval);
      }

      document.getElementById('gameTimer').classList.add('show');
      isTimerRunning = true;

      gameTimerInterval = setInterval(() => {
        gameTimeInSeconds++;
        updateTimerDisplay();
      }, 1000);

      setTimerInterval = setInterval(() => {
        setTimeInSeconds++;
        updateTimerDisplay();
      }, 1000);

      updateTimerDisplay();
    }

    function stopAllTimers() {
      if (gameTimerInterval) {
        clearInterval(gameTimerInterval);
        gameTimerInterval = null;
      }
      if (setTimerInterval) {
        clearInterval(setTimerInterval);
        setTimerInterval = null;
      }
      isTimerRunning = false;
      updateTimerDisplay();
    }

    function toggleTimer() {
        if (!gameStarted || gameEnded) {
            displayMessage("O cronômetro só pode ser pausado/retomado durante uma partida ativa.", "warning");
            return;
        }
        if (isTimerRunning) {
            stopAllTimers();
        } else {
            startAllTimers();
        }
    }

    function listenForAppointments() {
        if (!userId) {
            console.warn("User ID não disponível para ouvir agendamentos.");
            return;
        }
        const appointmentsCollectionRef = db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/appointments`);

        appointmentsCollectionRef.onSnapshot((snapshot) => {
            const fetchedAppointments = [];
            snapshot.forEach((doc) => {
                fetchedAppointments.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            renderAppointments(fetchedAppointments); 
            console.log("Agendamentos atualizados do Firestore:", fetchedAppointments);
        }, (error) => {
            console.error("Erro ao ouvir agendamentos do Firestore:", error);
            displayMessage("Erro ao carregar agendamentos do Firebase. Verifique sua conexão ou regras de segurança.", "error");
        });
    }

    async function addAppointment() {
        if (!userId) {
            displayMessage("Por favor, faça login para adicionar agendamentos.", "warning");
            return;
        }

        const gameDateInput = document.getElementById('gameDate');
        const gameTimeInput = document.getElementById('gameTime');
        const gameLocationInput = document.getElementById('gameLocation');

        const date = gameDateInput.value;
        const time = gameTimeInput.value;
        const location = gameLocationInput.value.trim();

        if (!date || !time || !location) {
            displayMessage("Por favor, preencha todos os campos do agendamento (Data, Hora, Local).", "error");
            return;
        }

        try {
            await db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/appointments`).add({
                date: date,
                time: time,
                location: location,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            gameDateInput.value = '';
            gameTimeInput.value = '';
            gameLocationInput.value = '';
            displayMessage("Agendamento adicionado com sucesso!", "success");
        } catch (error) {
            console.error("Erro ao adicionar agendamento:", error);
            displayMessage(`Erro ao adicionar agendamento: ${error.message}`, "error");
        }
    }

    async function deleteAppointment(appointmentId) {
        if (!userId) {
            displayMessage("Por favor, faça login para remover agendamentos.", "warning");
            return;
        }

        showConfirmationModal("Tem certeza que deseja remover este agendamento?", async (confirmed) => {
            if (confirmed) {
                try {
                    await db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/appointments`).doc(appointmentId).delete();
                    displayMessage("Agendamento removido!", "info");
                } catch (error) {
                    console.error("Erro ao remover agendamento:", error);
                    displayMessage(`Erro ao remover agendamento: ${error.message}`, "error");
                }
            }
        });
    }

    function formatDate(dateString) {
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    function renderAppointments(appointmentsToRender) {
        const upcomingAppointmentsList = document.getElementById('upcomingAppointmentsList');
        const pastAppointmentsList = document.getElementById('pastAppointmentsList');
        
        upcomingAppointmentsList.innerHTML = '';
        pastAppointmentsList.innerHTML = '';

        if (!appointmentsToRender || appointmentsToRender.length === 0) {
            upcomingAppointmentsList.innerHTML = '<p style="text-align: center; color: var(--text-color);">Nenhum agendamento futuro. Adicione um para começar!</p>';
            pastAppointmentsList.innerHTML = '<p style="text-align: center; color: var(--text-color);">Nenhum jogo anterior registrado.</p>';
            return;
        }

        appointmentsToRender.sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.toDate() : new Date(`${a.date}T${a.time}`);
            const timeB = b.timestamp ? b.timestamp.toDate() : new Date(`${b.date}T${b.time}`);
            return timeA - timeB;
        });

        const now = new Date();
        let hasUpcoming = false;
        let hasPast = false;

        appointmentsToRender.forEach((appointment) => {
            const li = document.createElement('li');
            li.dataset.id = appointment.id; 

            const appointmentDateTime = new Date(`${appointment.date}T${appointment.time}`);
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const appointmentDateOnly = new Date(appointmentDateTime.getFullYear(), appointmentDateTime.getMonth(), appointmentDateTime.getDate());

            const isPast = appointmentDateOnly < today;

            const statusClass = isPast ? 'appointment-past' : 'appointment-upcoming';

            li.innerHTML = `
                <div class="appointment-card ${statusClass}">
                    <div class="card-header">
                        <span class="card-date"><i class="fas fa-calendar-alt"></i> ${formatDate(appointment.date)}</span>
                        <span class="card-time"><i class="fas fa-clock"></i> ${appointment.time}</span>
                    </div>
                    <div class="card-body">
                        <p class="card-location"><i class="fas fa-map-marker-alt"></i> <strong>Local:</strong> ${appointment.location}</p>
                    </div>
                    <button class="delete-appointment-btn" data-id="${appointment.id}" title="Excluir agendamento"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;

            if (isPast) {
                pastAppointmentsList.appendChild(li);
                hasPast = true;
            } else {
                upcomingAppointmentsList.appendChild(li);
                hasUpcoming = true;
            }
        });

        if (!hasUpcoming) {
            upcomingAppointmentsList.innerHTML = '<p style="text-align: center; color: var(--text-color);">Nenhum agendamento futuro.</p>';
        }
        if (!hasPast) {
            pastAppointmentsList.innerHTML = '<p style="text-align: center; color: var(--text-color);">Nenhum jogo anterior registrado.</p>';
        }

        document.querySelectorAll('.delete-appointment-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const idToDelete = event.currentTarget.dataset.id;
                deleteAppointment(idToDelete);
            });
        });
    }

    function listenForPlayers() {
        if (!userId) {
            console.warn("User ID não disponível para ouvir jogadores.");
            return;
        }
        const playersCollectionRef = db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/players`);

        playersCollectionRef.onSnapshot((snapshot) => {
            const fetchedPlayers = [];
            snapshot.forEach((doc) => {
                fetchedPlayers.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            renderPlayerList(fetchedPlayers); 
            console.log("Jogadores atualizados do Firestore:", fetchedPlayers);
        }, (error) => {
            console.error("Erro ao ouvir jogadores do Firestore:", error);
            displayMessage("Erro ao carregar jogadores do Firebase. Verifique sua conexão ou regras de segurança.", "error");
        });
    }

    async function deletePlayerFromFirestore(playerId) {
        if (!userId) {
            displayMessage("Por favor, faça login para remover jogadores.", "warning");
            return;
        }
        try {
            await db.collection(`artifacts/${firebaseConfig.projectId}/users/${userId}/players`).doc(playerId).delete();
            displayMessage("Jogador removido!", "info");
            resetGame();
        } catch (error) {
            console.error("Erro ao remover jogador:", error);
            displayMessage(`Erro ao remover jogador: ${error.message}`, "error");
        }
    }

    async function displaySystemVersion() {
        console.log('Attempting to load system version from service-worker.js...');
        try {
            const response = await fetch('./service-worker.js');
            console.log('Fetch response received:', response);

            if (!response.ok) {
                console.error('Service Worker fetch failed with status:', response.status, response.statusText);
                document.getElementById('systemVersionDisplay').textContent = 'Erro ao carregar (status: ' + response.status + ')';
                return;
            }

            const text = await response.text();
            console.log('Service Worker content fetched successfully. Content start:', text.substring(0, 50) + '...');
            const match = text.match(/const CACHE_NAME = '(placar-volei-v[^']+)';/);
            
            if (match && match[1]) {
                document.getElementById('systemVersionDisplay').textContent = match[1];
                console.log('System version loaded:', match[1]);
            } else {
                document.getElementById('systemVersionDisplay').textContent = 'Não disponível';
                console.warn('System version pattern not found in service-worker.js. Content might be unexpected.');
            }
        } catch (error) {
            console.error('Erro ao carregar a versão do Service Worker:', error);
            document.getElementById('systemVersionDisplay').textContent = 'Erro ao carregar';
        }
    }


    window.onload = () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(() => {})
          .catch(error => {});
      }
      loadSettings();
      displaySystemVersion();

      // Get references to login UI elements
      loginOverlay = document.getElementById('loginOverlay');
      loginMessage = document.getElementById('loginMessage');
      appContent = document.getElementById('appContent');

      // Start authentication process
      authenticateUser();

      scoreA = 0;
      scoreB = 0;
      setsA = 0;
      setsB = 0;
      gameEnded = false;
      gameStarted = false;
      lastWinningTeam = null; 
      currentPlayingTeamA = { name: 'Time A', players: [], color: '#007bff' };
      currentPlayingTeamB = { name: 'Time B', players: [], color: '#dc3545' };

      document.getElementById("scoreA").textContent = scoreA;
      document.getElementById("scoreB").textContent = scoreB;
      updateSetsDisplay();
      updateScoreboardTeamsDisplay();

      document.getElementById('startGameButton').style.display = 'block';
      document.getElementById('scoreboardOverlay').classList.remove('hidden');

      updateSwapTeamsButtonVisibility();
      updateResetButtonVisibility();

      renderGeneratedTeams();

      setupSwipeToDecrease('sectionA', 'A');
      setupSwipeToDecrease('sectionB', 'B');
      setupSwipeBetweenSections();

      document.getElementById('sectionA').addEventListener('click', (e) => {
        if (e.target.closest('.team-name') || e.target.closest('.player-info-container')) {
            showManageTeamModal('A');
        } else {
            changeScore('A', 1);
        }
      });
      document.getElementById('sectionB').addEventListener('click', (e) => {
        if (e.target.closest('.team-name') || e.target.closest('.player-info-container')) {
            showManageTeamModal('B');
        } else {
            changeScore('B', 1);
        }
      });
      updateTimerDisplay();
    }
  </script>
</body>
</html>

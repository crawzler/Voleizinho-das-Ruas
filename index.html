<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <title>Placar Vôlei</title>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --accent-color: #545454;
      --input-bg-color: #f0f0f0;
      --input-text-color: #1a1a1a;
      --menu-bg-color: #333;
      --menu-hover-bg-color: #555;
      --list-item-bg: #3a3a3a;
      --gear-button-bg: rgba(0, 0, 0, 0.6);
      --neutral-hover-bg: rgba(51, 51, 51, 0.8);

      --victory-bg-start: #4CAF50;
      --victory-bg-end: #8BC34A;
      --victory-text-color: #ffffff;
      --victory-shadow-color: rgba(0,0,0,0.8);
      --crown-color: gold;
      --star-color: gold;

      --modal-bg: rgba(0, 0, 0, 0.8);
      --modal-content-bg: #2a2a2a;
      --modal-text-color: #ffffff;
      --modal-button-bg: #007bff;
      --modal-button-hover-bg: #0056b3;
      --modal-button-text: #ffffff;

      --card-bg-color: #2c2c2c;
      --card-border-color: #666;
      --collapsible-header-bg: #444;
      --collapsible-header-hover-bg: #555;
      --setting-item-bg: #3a3a3a;
      --setting-section-bg: #222222;
      --setting-item-border: rgba(255, 255, 255, 0.1);
    }

    body.light-theme {
      --bg-color: #f0f0f0;
      --text-color: #1a1a1a;
      --accent-color: #cccccc;
      --input-bg-color: #ffffff;
      --input-text-color: #1a1a1a;
      --menu-bg-color: #eee;
      --menu-hover-bg-color: #ddd;
      --list-item-bg: #e0e0e0;
      --gear-button-bg: rgba(255, 255, 255, 0.6);
      --neutral-hover-bg: rgba(204, 204, 204, 0.8);

      --victory-bg-start: #60B360;
      --victory-bg-end: #A0D8A0;
      --victory-text-color: #1a1a1a;
      --victory-shadow-color: rgba(255,255,255,0.8);
      --crown-color: #DAA520;
      --star-color: #DAA520;

      --modal-bg: rgba(255, 255, 255, 0.8);
      --modal-content-bg: #ffffff;
      --modal-text-color: #1a1a1a;
      --modal-button-bg: #4682B4;
      --modal-button-hover-bg: #32628C;
      --modal-button-text: #ffffff;

      --card-bg-color: #f8f8f8;
      --card-border-color: #aaa;
      --collapsible-header-bg: #ddd;
      --collapsible-header-hover-bg: #ccc;
      --setting-item-bg: #e0e0e0;
      --setting-section-bg: #f0f0f0;
      --setting-item-border: rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #pontuacao.section {
      padding: 0;
      display: flex;
      flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .scoreboard {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }

    .team-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding-top: 20px;
      text-align: center;
      touch-action: none;
      transition: none;
      position: relative;
    }

    .score {
      font-size: 15rem;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      user-select: none;
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
      transition: none;
      margin-bottom: 5px;
    }

    .team-name {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: #ffffff;
      transition: none;
    }

    .set-indicators {
      position: absolute;
      top: 10px;
      display: flex;
      gap: 5px;
      z-index: 5;
    }

    .set-indicators.left {
      left: 10px;
    }

    .set-indicators.right {
      right: 10px;
    }

    .set-star {
      font-size: 1.5rem;
      color: var(--star-color);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .player-info-container {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
      padding: 2px;
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      max-width: 120px;
      box-shadow: none;
      transition: background-color 0.3s ease;
    }

    .player-info-container.top-left {
      top: 10px;
      left: 10px;
    }

    .player-info-container.top-right {
      top: 10px;
      right: 10px;
    }

    .player-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      width: 100%;
      max-height: 100px;
      overflow-y: auto;
      opacity: 1;
    }

    .player-list li {
      background: none;
      padding: 1px 0;
      margin-bottom: 0;
      border-radius: 0;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
    }

    .btn {
      background-color: var(--accent-color);
      color: var(--text-color);
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .gear-button {
      position: fixed;     
      background-color: var(--gear-button-bg);
      border-radius: 0.4rem;
      border-style: unset;
      top: 1rem;
      right: 1rem;
      width: 2rem;
      height: 2rem;
      z-index: 1001;
      transition: background-color 0.3s ease;
    }

    .gear-button i {
      color: var(--text-color);
      transition: color 0.3s ease;
    }

    .menu {
      position: fixed;
      top: 3.5rem;
      right: 1rem;
      background-color: var(--menu-bg-color);
      border-radius: 8px;
      overflow: hidden;
      display: none;
      flex-direction: column;
      z-index: 1002;
      transition: background-color 0.3s ease;
    }

    .menu.show {
      display: flex !important;
    }

    .menu button {
      background: none;
      border: none;
      color: var(--text-color);
      padding: 1rem;
      text-align: left;
      width: 200px;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .menu button:hover {
      background-color: var(--menu-hover-bg-color);
    }
    
    .menu button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .section {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      overflow-y: auto;
      padding: 1rem;
      opacity: 0;
      pointer-events: none;
      transform: scale(0.9);
      transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
      z-index: 1;
    }

    .active {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
      z-index: 2;
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid var(--accent-color);
      color: var(--input-text-color);
      background-color: var(--input-bg-color);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    input:focus, select:focus {
        outline: none;
        border-color: var(--modal-button-bg);
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    ul li {
      background: var(--list-item-bg);
      padding: 0.5rem;
      margin-bottom: 0.25rem;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      transition: background-color 0.3s ease;
    }

    ul li span {
      flex: 1;
    }

    .start-game-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 1.5rem 3rem;
      font-size: 2rem;
      z-index: 100;
      background-color: #28a745;
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .start-game-button:hover {
      background-color: #218838;
      transform: translate(-50%, -50%) scale(1.05);
    }

    .start-game-button.disabled-visual {
      background-color: #6c757d;
      cursor: not-allowed;
      box-shadow: none;
      transform: translate(-50%, -50%);
    }
    .start-game-button.disabled-visual:hover {
      background-color: #6c757d;
      transform: translate(-50%, -50%);
    }

    .adicionar {
      display: flex;
      gap: 1rem;
    }

    #playerCounter {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: right;
      margin: 0.5rem 0;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .overlay.show {
      display: block;
    }

    .config-group {
      margin-bottom: 0.75rem;
      padding: 0.75rem;
      border-radius: 8px;
      background-color: var(--setting-item-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid var(--setting-item-border);
    }
    .config-group:last-child {
        margin-bottom: 0;
    }

    .config-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: var(--text-color);
    }

    .collapsible-container {
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        border: 1px solid var(--card-border-color);
    }

    .collapsible-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: var(--collapsible-header-bg);
        padding: 0.8rem 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    .collapsible-header:hover {
        background-color: var(--collapsible-header-hover-bg);
    }
    .collapsible-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--text-color);
    }
    .collapsible-arrow {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }
    .collapsible-arrow.rotated {
        transform: rotate(90deg);
    }
    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        padding: 0 1rem;
        background-color: var(--setting-section-bg);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .collapsible-content.show {
        max-height: 600px;
        padding-top: 1rem;
        padding-bottom: 1rem;
    }

    .player-info-container.hidden-players {
        display: none;
    }

    .color-picker-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 0;
    }
    .color-picker-group label {
        flex-grow: 1;
        margin-bottom: 0;
    }
    .color-picker-group input[type="color"] {
        width: 40px;
        height: 40px;
        padding: 0;
        border: 1px solid var(--accent-color);
        border-radius: 5px;
        cursor: pointer;
        background-color: transparent;
        transition: border-color 0.3s ease;
    }
    .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
    }
    .color-picker-group input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 5px;
    }
    .color-picker-group input[type="color"]:focus {
        border-color: var(--modal-button-bg);
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .checkbox-group {
        display: flex;
	      flex-grow: 1;
        align-items: center;
        justify-content: space-between;
        background-color: var(--setting-item-bg);
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid var(--setting-item-border);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    .checkbox-group label {
        margin-bottom: 0;
        flex-grow: 1;
        cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin: 0;
        cursor: pointer;
        accent-color: var(--modal-button-bg);
    }

    @media (orientation: landscape) {
      .scoreboard {
        flex-direction: row;
      }

      .score {
        font-size: 10rem;
      }

      .team-name {
        font-size: 2rem;
      }
      .player-info-container {
        max-width: 100px;
        top: 10px;
      }
      .player-list {
        font-size: 0.7rem;
        max-height: 70px;
      }

      .set-indicators.left {
        top: 50%;
        left: 10px;
        flex-direction: column;
        transform: translateY(-50%);
      }
      .set-indicators.right {
        top: 50%;
        right: 10px;
        flex-direction: column;
        transform: translateY(-50%);
      }
    }

    @media (max-width: 480px) {
      .score {
        font-size: 15rem;
      }
    }

    .victory-elements {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.5s ease-out;
      z-index: 10;
    }

    .victory-elements.show {
      opacity: 1;
    }

    .crown-container {
      position: absolute;
      top: 20%;
      transform: translateX(-50%);
      left: 50%;
      z-index: 20;
      opacity: 0;
      animation: crownAppear 1.5s ease-out forwards;
    }

    .crown-icon {
      font-size: 8rem;
      color: var(--crown-color);
      text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    }

    .confetti-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      background-color: #f00;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes crownAppear {
      0% {
        transform: translate(-50%, -100px) scale(0.5);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, 20px) scale(1.2);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, 0) scale(1);
        opacity: 1;
      }
    }

    @keyframes confettiFall {
      from {
        transform: translate(0, 0) rotate(0deg);
        opacity: 1;
      }
      to {
        transform: translate(var(--confetti-end-x), var(--confetti-end-y)) rotate(var(--confetti-rotate-deg));
        opacity: 0;
      }
    }

    @keyframes scoreIncreaseAnim {
      0% { transform: scale(1); color: #ffffff; }
      50% { transform: scale(1.1); color: #8bc34a; }
      100% { transform: scale(1); color: #ffffff; }
    }

    @keyframes scoreDecreaseAnim {
      0% { transform: scale(1); color: #ffffff; }
      50% { transform: scale(0.9); color: #ff6347; }
      100% { transform: scale(1); color: #ffffff; }
    }

    .score.increase-anim {
      animation: scoreIncreaseAnim 0.3s ease-out forwards;
    }

    .score.decrease-anim {
      animation: scoreDecreaseAnim 0.3s ease-out forwards;
    }

    .game-over-modal, .increase-score-modal, .start-game-modal, .super-victory-modal, .custom-message-modal, .custom-confirmation-modal, .manage-team-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-bg);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }

    .game-over-modal.show, .increase-score-modal.show, .start-game-modal.show, .super-victory-modal.show, .custom-message-modal.show, .custom-confirmation-modal.show, .manage-team-modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content, .increase-score-content, .super-victory-content, .custom-message-content, .custom-confirmation-content, .manage-team-content {
      background-color: var(--modal-content-bg);
      padding: clamp(10px, 4vw, 20px);
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 90vw;
      max-height: 90vh;
      width: clamp(250px, 85vw, 380px);
      transform: translateY(-20px);
      opacity: 0;
      animation: modalPopIn 0.4s ease-out forwards;
      color: var(--modal-text-color);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      gap: 10px;
    }

    .start-game-content {
        background-color: var(--modal-content-bg);
        padding: clamp(15px, 5vw, 30px);
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        max-width: 95vw;
        max-height: 95vh;
        width: clamp(280px, 90vw, 450px);
        transform: translateY(-20px);
        opacity: 0;
        animation: modalPopIn 0.4s ease-out forwards;
        color: var(--modal-text-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        gap: 15px;
    }

    .modal-content h3, .increase-score-content h3, .super-victory-content h3, .start-game-content h3, .custom-message-content h3, .custom-confirmation-content h3, .manage-team-content h3 {
      font-size: clamp(1.6rem, 5.5vw, 2.2rem);
      margin-bottom: 0;
    }

    .modal-content p, .increase-score-content p, .super-victory-content p, .start-game-content p, .custom-message-content p, .custom-confirmation-content p, .manage-team-content p {
      font-size: clamp(0.9rem, 3vw, 1.3rem);
      margin-bottom: 0;
    }

    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      justify-content: space-evenly;
      flex-wrap: wrap;
    }

    .modal-buttons button {
      background-color: var(--modal-button-bg);
      color: var(--modal-button-text);
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: clamp(0.9rem, 3vw, 1.1rem);
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease;
      flex: 1;
      min-width: 90px;
    }

    .modal-buttons button:hover {
      background-color: var(--modal-button-hover-bg);
    }

    .increase-score-content input[type="number"],
    .start-game-content input[type="number"],
    .start-game-content select,
    .manage-team-content select {
      width: 100%;
      margin-bottom: 0;
      text-align: center;
      font-size: clamp(1.3rem, 4.5vw, 1.8rem);
      padding: 6px;
    }

    .start-game-content .input-group,
    .manage-team-content .input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 48%;
      gap: 5px;
    }

    .start-game-content .input-row,
    .manage-team-content .input-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      gap: 10px;
    }

    .start-game-content label,
    .manage-team-content label {
      display: block;
      margin-bottom: 0;
      font-size: clamp(0.8rem, 2.8vw, 1rem);
      text-align: center;
    }

    .scoreboard-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 50;
      display: block;
      opacity: 1;
      transition: opacity 0.5s ease-in-out;
    }

    .scoreboard-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .super-victory-modal {
      background: linear-gradient(45deg, #FFD700, #FFA500, #FF4500);
      animation: gradientAnimation 5s ease infinite alternate;
      color: #fff;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.6);
      font-weight: bold;
      z-index: 4000;
    }

    .super-victory-content {
      background-color: rgba(0,0,0,0.7);
      color: #fff;
      padding: clamp(20px, 7vw, 40px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      animation: modalPopIn 0.5s ease-out forwards;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      gap: 15px;
    }

    .super-victory-content h3 {
      font-size: clamp(2.2rem, 7vw, 3.5rem);
      margin-bottom: 0;
      text-transform: uppercase;
      letter-spacing: clamp(1px, 0.8vw, 4px);
    }

    .super-victory-content p {
      font-size: clamp(1.2rem, 4vw, 2rem);
      margin-bottom: 0;
    }

    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    @keyframes modalPopIn {
      from {
        transform: translateY(-50px) scale(0.8);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    @media (orientation: landscape) {
      .modal-buttons {
        flex-direction: row;
      }
      .start-game-content .input-row,
      .manage-team-content .input-row {
        flex-direction: row;
      }
      .start-game-content > div,
      .manage-team-content > div {
        flex-direction: column;
      }
      .start-game-content .modal-buttons,
      .manage-team-content .modal-buttons {
        flex-basis: 100%;
        flex-direction: row;
        justify-content: space-evenly;
      }
    }

    .teams-display-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
        justify-content: center;
    }

    .team-card {
        background: linear-gradient(145deg, var(--card-bg-color), var(--collapsible-header-bg));
        border-radius: 15px;
        padding: 25px;
        width: 100%;
        max-width: 300px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        display: flex;
        flex-direction: column;
        align-items: center;
        border: none;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: default;
    }

    .team-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 10px;
        height: 100%;
        background-color: var(--team-card-dynamic-border-color, var(--accent-color));
        transition: background-color 0.3s ease;
    }

    .team-card:hover {
        /* Removido transform e box-shadow para desativar a interação visual */
    }

    .team-card h4 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.5rem;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
    }

    .team-card .team-color-indicator {
        display: none;
    }

    .team-card .player-list-compact {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-color);
        text-align: center;
        width: 100%;
    }
    .team-card .player-list-compact li {
        background: none;
        padding: 6px 0;
        margin-bottom: 4px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-bottom: 1px solid rgba(255,255,255,0.15);
        color: rgba(255,255,255,0.9);
    }
    .team-card .player-list-compact li:last-child {
        border-bottom: none;
    }

    @media (min-width: 600px) {
        .team-card {
            width: calc(50% - 20px);
        }
    }

    @media (min-width: 900px) {
        .team-card {
            width: calc(33.33% - 20px);
        }
    }

    .swap-teams-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--gear-button-bg);
      color: var(--text-color);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 100;
      transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      pointer-events: none;
    }

    .swap-teams-button.show {
        opacity: 1;
        pointer-events: auto;
    }

    .swap-teams-button:hover,
    .swap-teams-button:active {
      background-color: var(--neutral-hover-bg);
      transform: translate(-50%, -50%) scale(1.05);
    }

    @keyframes fadeOutAndShrink {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.8); }
    }
    @keyframes fadeInAndGrow {
      0% { opacity: 0; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1); }
    }
    .team-section.fade-out {
      animation: fadeOutAndShrink 0.3s ease-out forwards;
    }
    .team-section.fade-in {
      animation: fadeInAndGrow 0.3s ease-out forwards;
    }

    .game-timer {
      position: absolute;
      bottom: 0px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--text-color);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
      background-color: rgba(0, 0, 0, 0.6);
      padding: 10px 20px;
      border-radius: 10px 10px 0px 0px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease-in-out, background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: auto;
      min-width: 150px;
    }

    .game-timer.show {
      opacity: 1;
    }

  </style>
</head>
<body>
  <button class="gear-button" onclick="toggleMenu()">
    <i class="fa-solid fa-bars"></i>
  </button>

  <div class="overlay" id="menuOverlay"></div>
  <div class="menu" id="gearMenu">
    <button onclick="navigateTo('pontuacao')"><i class="fa-solid fa-medal" style="margin-right: 0.5rem;"></i>Pontuação</button>
    <button onclick="navigateTo('times')"><i class="fa-solid fa-shuffle" style="margin-right: 0.5rem;"></i>Times</button>
    <button onclick="navigateTo('jogadores')"><i class="fa-solid fa-users" style="margin-right: 0.5rem;"></i>Jogadores</button>
    <button onclick="navigateTo('configuracoes')"><i class="fa-solid fa-gear" style="margin-right: 0.5rem;"></i>Configurações</button>
    <button id="resetGameButton" class="disabled" onclick="confirmReset()"><i class="fa-solid fa-rotate-right" style="margin-right: 0.5rem;"></i>Reiniciar Partida</button>
  </div>

  <div id="pontuacao" class="section active">
    <div class="scoreboard-overlay" id="scoreboardOverlay"></div>
    <div class="scoreboard">
      <div class="team-section" id="sectionA">
        <div class="victory-elements">
          <div class="crown-container">
            <i class="fa-solid fa-crown crown-icon"></i>
          </div>
          <div class="confetti-container"></div>
        </div>
        <div class="set-indicators left" id="setIndicatorA"></div>
        <div class="team-name" id="teamNameA"></div>
        <div class="player-info-container top-left">
          <ul class="player-list" id="playerListA"></ul>
        </div>
        <div class="score" id="scoreA">0</div>
      </div>
      <div class="team-section" id="sectionB">
        <div class="victory-elements">
          <div class="crown-container">
            <i class="fa-solid fa-crown crown-icon"></i>
          </div>
          <div class="confetti-container"></div>
        </div>
        <div class="set-indicators right" id="setIndicatorB"></div>
        <div class="team-name" id="teamNameB"></div>
        <div class="player-info-container top-left">
          <ul class="player-list" id="playerListB"></ul>
        </div>
        <div class="score" id="scoreB">0</div>
      </div>
    </div>
    <button class="btn start-game-button" id="startGameButton" onclick="showStartGameModal()">Iniciar Partida</button>
    <button class="swap-teams-button" id="swapTeamsButton" onclick="swapTeams()">
      <i class="fa-solid fa-right-left"></i>
    </button>
  </div>

  <div id="times" class="section">
    <h2>Gerar Times</h2>
    <label>Jogadores por time:</label>
    <span class="adicionar">
      <input type="number" id="playersPerTeam" min="1" value="4" />
      <button class="btn" onclick="generateCustomTeams()">Gerar</button>
    </span>    
    <div class="teams-display-container" id="teamsContainer">
        </div>
  </div>

  <div id="jogadores" class="section">
    <h2>Jogadores</h2>
    <span class="adicionar">
      <input type="text" id="playerName" placeholder="Nome do jogador" />
      <button class="btn" onclick="addPlayer()">Adicionar</button>
    </span>
    <span style="display:flex;flex-direction: row-reverse;justify-content: space-between;">
          <div id="playerCounter">0/0</div>

      <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button class="btn" id="toggleSelectAllButton" onclick="toggleSelectAllPlayers()">Alternar Seleção</button>
      </div>
    </span>

    <ul id="playerList"></ul>

    </div>

  <div id="configuracoes" class="section">
    <h2 style=" margin-bottom: 20px;">Configurações</h2>
    
    <div class="collapsible-container">
        <div class="collapsible-header" onclick="toggleGeneralSettingsSection()">
            <h3>Geral</h3>
            <i class="fa-solid fa-chevron-right collapsible-arrow" id="generalSettingsArrow"></i>
        </div>
        <div class="collapsible-content" id="generalSettingsContent">
          <div class="config-group">
            <label for="winningScore">Pontos para Vencer (Set):</label>
            <input type="number" id="winningScore" min="1" value="15" onchange="saveSettings()">
          </div>
          <div class="config-group">
            <label for="setsToWinConfig">Número de Sets para Vencer a Partida (0 para ilimitado):</label>
            <input type="number" id="setsToWinConfig" min="0" value="1" onchange="saveSettings()">
          </div>
          <div class="config-group">
            <label for="themeSelect">Tema:</label>
            <select id="themeSelect" onchange="setTheme(this.value)">
              <option value="dark">Escuro</option>
              <option value="light">Claro</option>
            </select>
          </div>
	<span style="display: flex;">
          <div class="checkbox-group">
                <label for="vibrationEnabled">Vibração ao Pontuar:</label>
                <input type="checkbox" id="vibrationEnabled" onchange="saveSettings()">
            </div>
            <div class="checkbox-group" style="margin-left: 20px;">
                <label for="showPlayersOnScoreboard">Exibir Jogadores no Placar:</label>
                <input type="checkbox" id="showPlayersOnScoreboard" onchange="saveSettings()">
            </div>
	</span>
        </div>
    </div>
    
    <div class="collapsible-container">
        <div class="collapsible-header" onclick="toggleCustomTeamNamesSection()">
            <h3>Times Personalizados</h3> <i class="fa-solid fa-chevron-right collapsible-arrow" id="customTeamNamesArrow"></i>
        </div>
        <div class="collapsible-content" id="customTeamNamesContent">
            <p style="font-size: 0.9em; color: var(--text-color); opacity: 0.8; margin-bottom: 0.5rem;">Defina nomes e cores para seus times favoritos. Eles aparecerão nas opções de seleção e ao gerar times.</p>
            <div class="config-group color-picker-group">
                <label for="customTeamName1">Time 1:</label>
                <input type="text" id="customTeamName1" value="" onchange="saveSettings()" style="flex: 1;">
                <input type="color" id="customTeamColor1" value="#007bff" onchange="saveSettings()">
            </div>
            <div class="config-group color-picker-group">
                <label for="customTeamName2">Time 2:</label>
                <input type="text" id="customTeamName2" value="" onchange="saveSettings()" style="flex: 1;">
                <input type="color" id="customTeamColor2" value="#dc3545" onchange="saveSettings()">
            </div>
            <div class="config-group color-picker-group">
                <label for="customTeamName3">Time 3:</label>
                <input type="text" id="customTeamName3" value="" onchange="saveSettings()" style="flex: 1;">
                <input type="color" id="customTeamColor3" value="#28a745" onchange="saveSettings()">
            </div>
            <div class="config-group color-picker-group">
                <label for="customTeamName4">Time 4:</label>
                <input type="text" id="customTeamName4" value="" onchange="saveSettings()" style="flex: 1;">
                <input type="color" id="customTeamColor4" value="#ffc107" onchange="saveSettings()">
            </div>
            <div class="config-group color-picker-group">
                <label for="customTeamName5">Time 5:</label>
                <input type="text" id="customTeamName5" value="" onchange="saveSettings()" style="flex: 1;">
                <input type="color" id="customTeamColor5" value="#6f42c1" onchange="saveSettings()">
            </div>
        </div>
    </div>

    <div class="collapsible-container">
        <div class="collapsible-header" onclick="toggleDataManagementSection()">
            <h3>Gerenciamento de Dados</h3> <i class="fa-solid fa-chevron-right collapsible-arrow" id="dataManagementArrow"></i>
        </div>
        <div class="collapsible-content" id="dataManagementContent">
            <div class="config-group">
                <label>Exportar Dados:</label>
                <button class="btn" onclick="exportSettings()">Exportar Configurações</button>
            </div>
            <div class="config-group">
                <label>Importar Dados:</label>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importSettings(event)">
                <button class="btn" onclick="document.getElementById('importFileInput').click()">Importar Configurações</button>
            </div>
        </div>
    </div>
  </div>

  <div id="gameOverModal" class="game-over-modal">
    <div class="modal-content">
      <h3 id="modalWinningTeamName"></h3>
      <p id="modalMessage"></p>
      <div class="modal-buttons">
        <button onclick="startNewGame()">Novo Jogo</button>
        <button id="newSetButton" onclick="startNewSet()">Novo Set</button>
        <button onclick="increaseWinningScoreModal()">Continuar partida</button>
      </div>
    </div>
  </div>

  <div id="increaseScoreModal" class="increase-score-modal">
    <div class="increase-score-content">
      <h3>Aumentar Pontuação</h3>
      <p>Defina o novo valor para a pontuação de vitória do set:</p>
      <input type="number" id="newWinningScoreInput" min="1" value="15">
      <div class="modal-buttons">
        <button onclick="confirmIncreaseWinningScore()">Confirmar</button>
        <button onclick="hideIncreaseScoreModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="startGameModal" class="start-game-modal">
    <div class="start-game-content">
      <h3>Iniciar Nova Partida</h3>
      <p>Defina as configurações da partida:</p>

      <div class="input-row">
        <div class="input-group">
          <label for="initialWinningScore">Pontos por set:</label>
          <input type="number" id="initialWinningScore" min="1" value="15">
        </div>
        <div class="input-group">
          <label for="initialNumberOfSets">Número de sets:</label>
          <input type="number" id="initialNumberOfSets" min="0" value="0">
        </div>
      </div>

      <div class="modal-buttons">
        <button id="modalStartGameButton" onclick="confirmStartGame()">Iniciar Partida</button>
        <button onclick="hideStartGameModal()" style="background-color: #dc3545; --modal-button-hover-bg: #c82333;">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="superVictoryModal" class="super-victory-modal">
    <div class="super-victory-content">
      <h3 id="superVictoryTeamName"></h3>
      <p>VENCEU A PARTIDA!</p>
      <div class="confetti-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
    </div>
  </div>

  <div id="manageTeamModal" class="manage-team-modal">
    <div class="modal-content manage-team-content">
      <h3 id="manageTeamModalTitle">Selecionar Time</h3>
      <div class="input-group" style="width: 100%;">
        <label for="selectTeamForManagement">Selecione um time:</label>
        <select id="selectTeamForManagement" onchange="saveTeamNameAndPlayers()">
          </select>
      </div>
      </div>
  </div>

  <script>
    const defaultCustomTeamColors = ["#007bff", "#dc3545", "#28a745", "#ffc107", "#6f42c1"];

    let players = JSON.parse(localStorage.getItem('players') || '[]');
    let checkedState = JSON.parse(localStorage.getItem('checkedPlayers') || '{}');
    let generatedTeams = JSON.parse(localStorage.getItem('generatedTeams') || '[]');
    let currentPlayingTeamA = JSON.parse(localStorage.getItem('currentPlayingTeamA')) || { name: 'Time A', players: [], color: '#007bff' };
    let currentPlayingTeamB = JSON.parse(localStorage.getItem('currentPlayingTeamB')) || { name: 'Time B', players: [], color: '#dc3545' };

    let scoreA = 0, scoreB = 0;
    let setsA = 0, setsB = 0;
    let gameEnded = false;
    let gameStarted = false; 
    let lastWinningTeam = null;

    let winningScore = parseInt(localStorage.getItem('winningScore') || '15');
    let setsToWin = parseInt(localStorage.getItem('setsToWin') || '1');
    
    let customTeamNames = JSON.parse(localStorage.getItem('customTeamNames') || '[]').map((team, index) => ({
        name: team.name || "",
        color: team.color || defaultCustomTeamColors[index] || '#cccccc'
    }));
    while (customTeamNames.length < 5) {
        customTeamNames.push({ name: "", color: defaultCustomTeamColors[customTeamNames.length] || '#cccccc' });
    }

    let currentTheme = localStorage.getItem('theme') || 'dark';
    let vibrationEnabled = JSON.parse(localStorage.getItem('vibrationEnabled') || 'true');
    let showPlayersOnScoreboard = JSON.parse(localStorage.getItem('showPlayersOnScoreboard') || 'true');

    let teamAColor = currentPlayingTeamA.color;
    let teamBColor = currentPlayingTeamB.color;

    let activeManageTeamId = null;

    function toggleMenu() {
      const menu = document.getElementById("gearMenu");
      const overlay = document.getElementById("menuOverlay");
      menu.classList.toggle("show");
      overlay.classList.toggle("show");
      updateResetButtonVisibility();

      if (menu.classList.contains("show")) {
        document.addEventListener('click', closeMenuOnOutsideClick);
      } else {
        document.removeEventListener('click', closeMenuOnOutsideClick);
      }
    }

    function closeMenuOnOutsideClick(e) {
      const menu = document.getElementById("gearMenu");
      const button = document.querySelector(".gear-button");
      if (!menu.contains(e.target) && !button.contains(e.target)) {
        if (menu.classList.contains("show")) {
            menu.classList.remove("show");
            document.getElementById("menuOverlay").classList.remove("show");
            document.removeEventListener('click', closeMenuOnOutsideClick);
        }
      }
    }

    function navigateTo(id) {
      showSection(id);
      document.getElementById("gearMenu").classList.remove("show");
      document.getElementById("menuOverlay").classList.remove("show");
      updateResetButtonVisibility();
    }

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      updateResetButtonVisibility();
      if (id === 'times') {
          renderGeneratedTeams();
      }
    }

    function updateResetButtonVisibility() {
        const resetButton = document.getElementById('resetGameButton');
        const pontuacaoSection = document.getElementById('pontuacao');
        
        if (gameStarted && pontuacaoSection.classList.contains('active')) {
            resetButton.classList.remove('disabled');
        } else {
            resetButton.classList.add('disabled');
        }
    }

    function saveCheckedState() {
      localStorage.setItem('checkedPlayers', JSON.stringify(checkedState));
    }

    function addPlayer() {
      const input = document.getElementById("playerName");
      const name = input.value.trim();
      if (name && !players.includes(name)) {
        players.push(name);
        checkedState[name] = true;
        input.value = "";
        updatePlayerList();
        localStorage.setItem('players', JSON.stringify(players));
        saveCheckedState();
      } else if (players.includes(name)) {
        displayMessage("Este nome já está na lista.", "warning");
      }
    }

    function updatePlayerList() {
      players.sort((a, b) => a.localeCompare(b, 'pt', { sensitivity: 'base' }));
      const list = document.getElementById("playerList");
      list.innerHTML = "";
      players.forEach((p, i) => {
        const li = document.createElement("li");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = checkedState[p] !== false;
        checkbox.style.marginRight = '0.5rem';
        checkbox.style.width = '1rem';
        checkbox.onchange = () => {
          checkedState[p] = checkbox.checked;
          saveCheckedState();
          updatePlayerCounter();
          updateToggleSelectAllButtonText();
        };

        const span = document.createElement("span");
        span.textContent = p;

        const btn = document.createElement("button");
        btn.textContent = "Remover";
        btn.className = "btn";
        btn.onclick = () => {
            showConfirmationModal("Tem certeza que deseja remover este jogador?", (confirmed) => {
                if (confirmed) {
                    players.splice(i, 1);
                    delete checkedState[p];
                    updatePlayerList();
                    localStorage.setItem('players', JSON.stringify(players));
                    saveCheckedState();
                    generatedTeams = [];
                    localStorage.removeItem('generatedTeams');
                    renderGeneratedTeams();
                    resetGame();
                }
            });
        };

        li.appendChild(checkbox);
        li.appendChild(span);
        li.appendChild(btn);
        list.appendChild(li);
      });

      updatePlayerCounter();
      updateToggleSelectAllButtonText();
    }

    function updatePlayerCounter() {
      const selected = players.filter(p => checkedState[p] !== false).length;
      const total = players.length;
      document.getElementById("playerCounter").textContent = `${selected}/${total}`;
    }

    function toggleSelectAllPlayers() {
      const allSelected = players.every(p => checkedState[p] !== false);
      let confirmationMessage;
      let action;

      if (allSelected) {
        confirmationMessage = "Tem certeza que deseja desmarcar todos os jogadores?";
        action = false;
      } else {
        confirmationMessage = "Tem certeza que deseja selecionar todos os jogadores?";
        action = true;
      }

      showConfirmationModal(confirmationMessage, (confirmed) => {
          if (confirmed) {
              players.forEach(p => checkedState[p] = action);
              saveCheckedState();
              updatePlayerList();
          }
      });
    }

    function updateToggleSelectAllButtonText() {
      const toggleButton = document.getElementById('toggleSelectAllButton');
      if (toggleButton) {
        const allSelected = players.every(p => checkedState[p] !== false);
        if (allSelected && players.length > 0) {
          toggleButton.textContent = "Desselecionar Todos";
        } else {
          toggleButton.textContent = "Selecionar Todos";
        }
      }
    }

    function confirmReset() {
        const resetButton = document.getElementById('resetGameButton');
        if (resetButton.classList.contains('disabled')) {
            return;
        }

        showConfirmationModal("Tem certeza que deseja reiniciar a pontuação? Isso irá zerar os pontos e sets de ambos os times.", (confirmed) => {
            if (confirmed) {
                resetGame();
                document.getElementById("gearMenu").classList.remove("show");
                document.getElementById("menuOverlay").classList.remove("show");
            }
        });
    }

    function resetGame() {
      scoreA = 0;
      scoreB = 0;
      setsA = 0;
      setsB = 0;
      gameEnded = false;
      gameStarted = false; 
      lastWinningTeam = null;
      currentPlayingTeamA = { name: 'Time A', players: [], color: '#007bff' };
      currentPlayingTeamB = { name: 'Time B', players: [], color: '#dc3545' };

      document.getElementById("scoreA").textContent = 0;
      document.getElementById("scoreB").textContent = 0;
      updateSetsDisplay();
      
      document.getElementById('startGameButton').style.display = 'block';
      document.getElementById('scoreboardOverlay').classList.remove('hidden');
      
      updateScoreboardTeamsDisplay();
      updateResetButtonVisibility();
      localStorage.setItem('currentPlayingTeamA', JSON.stringify(currentPlayingTeamA));
      localStorage.setItem('currentPlayingTeamB', JSON.stringify(currentPlayingTeamB));
      updateSwapTeamsButtonVisibility(); 
      saveAppState();
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateCustomTeams() {
      const perTeam = parseInt(document.getElementById("playersPerTeam").value);
      if (isNaN(perTeam) || perTeam <= 0) {
        displayMessage("Informe um número válido de jogadores por time.", "error");
        return;
      }

      const selectedPlayers = players.filter(p => checkedState[p] !== false);
      if (selectedPlayers.length < 2) {
        displayMessage("Selecione pelo menos dois jogadores.", "error");
        return;
      }
      if (selectedPlayers.length < perTeam) {
          displayMessage(`Você precisa de pelo menos ${perTeam} jogadores selecionados para gerar um time.`, "error");
          return;
      }

      shuffle(selectedPlayers);
      generatedTeams = [];

      let teamCount = 0;
      for (let i = 0; i < selectedPlayers.length; i += perTeam) {
        teamCount++;
        const customTeam = customTeamNames[teamCount - 1];
        const teamName = customTeam && customTeam.name.trim() !== ""
                         ? customTeam.name
                         : `Time ${teamCount}`;
        const teamColor = customTeam ? customTeam.color : defaultCustomTeamColors[teamCount - 1] || '#cccccc';
        
        generatedTeams.push({ name: teamName, players: selectedPlayers.slice(i, i + perTeam), color: teamColor });
      }
      
      localStorage.setItem('generatedTeams', JSON.stringify(generatedTeams));
      renderGeneratedTeams();
      displayMessage(`${teamCount} time(s) gerado(s) com sucesso!`, "success");

      // Seleção aleatória de times para o placar
      if (generatedTeams.length >= 2) {
          const shuffledGeneratedTeams = [...generatedTeams]; // Cria uma cópia para embaralhar
          shuffle(shuffledGeneratedTeams); // Embaralha a cópia
          currentPlayingTeamA = { ...shuffledGeneratedTeams[0] };
          currentPlayingTeamB = { ...shuffledGeneratedTeams[1] };
          localStorage.setItem('currentPlayingTeamA', JSON.stringify(currentPlayingTeamA));
          localStorage.setItem('currentPlayingTeamB', JSON.stringify(currentPlayingTeamB));
          teamAColor = currentPlayingTeamA.color; // Atualiza a cor do time A
          teamBColor = currentPlayingTeamB.color; // Atualiza a cor do time B
          updateScoreboardTeamsDisplay();
          displayMessage(`Times "${currentPlayingTeamA.name}" e "${currentPlayingTeamB.name}" definidos no placar.`, "info");
      } else if (generatedTeams.length === 1) {
          currentPlayingTeamA = { ...generatedTeams[0] };
          currentPlayingTeamB = { name: 'Time B', players: [], color: '#dc3545' };
          localStorage.setItem('currentPlayingTeamA', JSON.stringify(currentPlayingTeamA));
          localStorage.setItem('currentPlayingTeamB', JSON.stringify(currentPlayingTeamB));
          teamAColor = currentPlayingTeamA.color; // Atualiza a cor do time A
          teamBColor = currentPlayingTeamB.color; // Atualiza a cor do time B
          updateScoreboardTeamsDisplay();
          displayMessage(`Time "${currentPlayingTeamA.name}" definido no placar.`, "info");
      } else {
          currentPlayingTeamA = { name: 'Time A', players: [], color: '#007bff' };
          currentPlayingTeamB = { name: 'Time B', players: [], color: '#dc3545' };
          localStorage.setItem('currentPlayingTeamA', JSON.stringify(currentPlayingTeamA));
          localStorage.setItem('currentPlayingTeamB', JSON.stringify(currentPlayingTeamB));
          teamAColor = currentPlayingTeamA.color; // Atualiza a cor do time A
          teamBColor = currentPlayingTeamB.color; // Atualiza a cor do time B
          updateScoreboardTeamsDisplay();
      }
      saveAppState();
    }

    function renderGeneratedTeams() {
        const container = document.getElementById("teamsContainer");
        container.innerHTML = "";

        if (generatedTeams.length === 0) {
            const noTeamsMsg = document.createElement('p');
            noTeamsMsg.textContent = 'Nenhum time gerado ainda. Vá em "Jogadores", selecione-os e depois use o botão "Gerar".';
            noTeamsMsg.style.textAlign = 'center';
            noTeamsMsg.style.fontStyle = 'italic';
            noTeamsMsg.style.color = 'rgba(255,255,255,0.7)';
            container.appendChild(noTeamsMsg);
            return;
        }

        generatedTeams.forEach((team) => {
            const teamCard = document.createElement("div");
            teamCard.classList.add("team-card");
            teamCard.style.setProperty('--team-card-dynamic-border-color', team.color);

            const teamNameEl = document.createElement("h4");
            teamNameEl.appendChild(document.createTextNode(team.name));

            teamCard.appendChild(teamNameEl);

            const playersList = document.createElement("ul");
            playersList.classList.add('player-list-compact');
            if (team.players.length === 0) {
                const playerLi = document.createElement("li");
                playerLi.textContent = "Sem jogadores";
                playerLi.style.fontStyle = 'italic';
                playerLi.style.color = 'rgba(255,255,255,0.5)';
                playersList.appendChild(playerLi);
            } else {
                team.players.forEach(player => {
                    const playerLi = document.createElement("li");
                    playerLi.textContent = player;
                    playersList.appendChild(playerLi);
                });
            }
            teamCard.appendChild(playersList);
            container.appendChild(teamCard);
        });
    }

    function setupSwipeToDecrease(id, team) {
      const el = document.getElementById(id);
      let startY = null;

      el.addEventListener('touchstart', e => {
        const playerInfoContainer = el.querySelector('.player-info-container');
        if (playerInfoContainer && playerInfoContainer.contains(e.target)) {
            startY = null;
            return;
        }
        if (e.touches.length === 1) {
          startY = e.touches[0].clientY;
        }
      });

      el.addEventListener('touchend', e => {
        if (startY !== null && e.changedTouches.length === 1) {
          const endY = e.changedTouches[0].clientY;
          if (endY - startY > 30) {
            changeScore(team, -1);
          }
          startY = null;
        }
      });
    }

    function triggerVibration() {
      if (vibrationEnabled && navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    function changeScore(team, delta) {
      if (!gameStarted) {
        if (delta > 0) displayMessage("Inicie uma partida primeiro!", "warning");
        return;
      }
      if (gameEnded) {
        return;
      }

      const scoreElement = document.getElementById('score' + team);
      scoreElement.classList.remove('increase-anim', 'decrease-anim');
      void scoreElement.offsetWidth; 

      if (team === 'A') {
        scoreA = Math.max(0, scoreA + delta);
        scoreElement.textContent = scoreA;
      } else {
        scoreB = Math.max(0, scoreB + delta);
        scoreElement.textContent = scoreB;
      }

      if (delta > 0) {
        scoreElement.classList.add('increase-anim');
        triggerVibration();
      } else if (delta < 0) {
        scoreElement.classList.add('decrease-anim');
        triggerVibration();
      }

      checkWinCondition();
      saveAppState();
    }

    function checkWinCondition() {
      if (gameEnded) return;

      let winner = null;
      if (scoreA >= winningScore && scoreA - scoreB >= 2) {
        winner = 'A';
      } else if (scoreB >= winningScore && scoreB - scoreA >= 2) {
        winner = 'B';
      }

      if (winner) {
        gameEnded = true;
        lastWinningTeam = winner;
        const winningTeamName = winner === 'A' ? currentPlayingTeamA.name : currentPlayingTeamB.name;
        showVictoryAnimation(winner, winningTeamName);
        updateSwapTeamsButtonVisibility(); 
        
        setTimeout(() => {
          let currentSetsA = setsA;
          let currentSetsB = setsB;
          if (winner === 'A') {
            currentSetsA++;
          } else {
            currentSetsB++;
          }

          if (setsToWin > 0 && (currentSetsA >= setsToWin || currentSetsB >= setsToWin)) {
            showSuperVictoryAnimation(winningTeamName);
          } else {
            showGameOverModal(winningTeamName, 'set_won');
          }
          saveAppState();
        }, 3000);
      }
    }

    function showVictoryAnimation(teamId, winningTeamName) {
      const teamSection = document.getElementById('section' + teamId);
      const victoryElements = teamSection.querySelector('.victory-elements');
      const crownContainer = victoryElements.querySelector('.crown-container');
      const confettiContainer = victoryElements.querySelector('.confetti-container');

      confettiContainer.innerHTML = '';

      victoryElements.classList.add('show');

      crownContainer.style.opacity = 0;
      crownContainer.style.animation = 'none';
      void crownContainer.offsetWidth; 
      crownContainer.style.animation = 'crownAppear 1.5s ease-out forwards';

      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f', '#ffa500'];
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.classList.add('confetti-piece');
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = confetti.style.width;
        
        const startX = teamSection.offsetWidth / 2;
        const startY = teamSection.offsetHeight / 2;
        confetti.style.left = `${startX}px`;
        confetti.style.top = `${startY}px`;

        const endX = (Math.random() - 0.5) * teamSection.offsetWidth * 1.5;
        const endY = (Math.random() - 0.5) * teamSection.offsetHeight * 1.5;
        const rotateDeg = Math.random() * 720;
        const duration = Math.random() * 1.5 + 1.5;
        const delay = Math.random() * 0.5;

        confetti.style.setProperty('--confetti-end-x', `${endX}px`);
        confetti.style.setProperty('--confetti-end-y', `${endY}px`);
        confetti.style.setProperty('--confetti-rotate-deg', `${rotateDeg}deg`);
        confetti.style.animation = `confettiFall ${duration}s ease-out ${delay}s forwards`;
        confetti.style.opacity = 1;

        confettiContainer.appendChild(confetti);

        confetti.addEventListener('animationend', () => {
          confetti.remove();
        });
      }

      setTimeout(() => {
        victoryElements.classList.remove('show');
      }, 3000);
    }

    function showGameOverModal(winningTeamName, gameStatus) {
      const modal = document.getElementById('gameOverModal');
      const modalWinningTeamName = document.getElementById('modalWinningTeamName');
      const modalMessage = document.getElementById('modalMessage');
      const newSetButton = document.getElementById('newSetButton');

      modalWinningTeamName.textContent = winningTeamName;
      if (gameStatus === 'game_won') {
        modalMessage.textContent = 'Venceu a Partida!';
        newSetButton.style.display = 'none';
      } else {
        modalMessage.textContent = 'Venceu o Set!';
        newSetButton.style.display = 'block';
      }
      modal.classList.add('show');
    }

    function hideGameOverModal() {
      document.getElementById('gameOverModal').classList.remove('show');
    }

    function increaseWinningScoreModal() {
      hideGameOverModal();
      document.getElementById('increaseScoreModal').classList.add('show');
      document.getElementById('newWinningScoreInput').value = winningScore + 5;
    }

    function hideIncreaseScoreModal() {
      document.getElementById('increaseScoreModal').classList.remove('show');
    }

    function confirmIncreaseWinningScore() {
      const newScore = parseInt(document.getElementById('newWinningScoreInput').value);
      if (isNaN(newScore) || newScore <= 0) {
        displayMessage("Por favor, insira um número de pontos válido.", "error");
        return;
      }
      if (newScore <= winningScore) {
        displayMessage(`A nova pontuação (${newScore}) deve ser maior que a pontuação atual (${winningScore}).`, "error");
        return;
      }

      winningScore = newScore;
      localStorage.setItem('winningScore', winningScore.toString());
      document.getElementById('winningScore').value = winningScore;
      displayMessage(`Pontuação para vencer aumentada para ${winningScore}!`, "success");
      hideIncreaseScoreModal();
      gameEnded = false;
      saveAppState();
    }

    function showStartGameModal() {
      document.getElementById('startGameModal').classList.add('show');
      document.getElementById('initialWinningScore').value = winningScore;
      document.getElementById('initialNumberOfSets').value = setsToWin;
      document.getElementById('startGameButton').style.display = 'none';
    }

    function hideStartGameModal() {
      document.getElementById('startGameModal').classList.remove('show');
      if (!gameStarted) { 
          document.getElementById('startGameButton').style.display = 'block';
          document.getElementById('scoreboardOverlay').classList.remove('hidden');
      }
    }

    function confirmStartGame() {
      const newWinningScore = parseInt(document.getElementById('initialWinningScore').value);
      const newSetsToWin = parseInt(document.getElementById('initialNumberOfSets').value);

      if (isNaN(newWinningScore) || newWinningScore <= 0) {
        displayMessage("Por favor, insira um valor válido para 'Pontos por set'.", "error");
        return;
      }
      if (isNaN(newSetsToWin) || newSetsToWin < 0) {
        displayMessage("Por favor, insira um valor válido para 'Número de sets'.", "error");
        return;
      }

      winningScore = newWinningScore;
      setsToWin = newSetsToWin;
      localStorage.setItem('winningScore', winningScore.toString());
      localStorage.setItem('setsToWin', setsToWin.toString());

      scoreA = 0;
      scoreB = 0;
      setsA = 0;
      setsB = 0;
      gameEnded = false;
      gameStarted = true; 

      document.getElementById("scoreA").textContent = scoreA;
      document.getElementById("scoreB").textContent = scoreB;
      updateSetsDisplay();

      hideStartGameModal();
      document.getElementById('startGameButton').style.display = 'none';
      document.getElementById('scoreboardOverlay').classList.add('hidden');
      
      updateScoreboardTeamsDisplay();
      updateResetButtonVisibility();
      updateSwapTeamsButtonVisibility(); 
      
      saveAppState();
    }

    function updateScoreboardTeamsDisplay() {
        const teamNameAEl = document.getElementById('teamNameA');
        const teamNameBEl = document.getElementById('teamNameB');
        const playerInfoContainerA = document.querySelector('#sectionA .player-info-container');
        const playerInfoContainerB = document.querySelector('#sectionB .player-info-container');
        const playerListAEl = document.getElementById('playerListA');
        const playerListBEl = document.getElementById('playerListB');

        teamNameAEl.textContent = currentPlayingTeamA.name;
        playerListAEl.innerHTML = currentPlayingTeamA.players.length > 0 ? 
                                  currentPlayingTeamA.players.map(p => `<li>${p}</li>`).join('') : 
                                  '<li style="font-style: italic; color: rgba(255,255,255,0.5);">Selecionar time</li>';

        teamNameBEl.textContent = currentPlayingTeamB.name;
        playerListBEl.innerHTML = currentPlayingTeamB.players.length > 0 ? 
                                  currentPlayingTeamB.players.map(p => `<li>${p}</li>`).join('') : 
                                  '<li style="font-style: italic; color: rgba(255,255,255,0.5);">Selecionar Time</li>';

        if (showPlayersOnScoreboard) {
            playerInfoContainerA.classList.remove('hidden-players');
            playerInfoContainerB.classList.remove('hidden-players');
        } else {
            playerInfoContainerA.classList.add('hidden-players');
            playerInfoContainerB.classList.add('hidden-players');
        }
        applyTeamColorsToScoreboard();
    }

    function startNewGame() {
      hideGameOverModal();
      resetGame();
      showStartGameModal();
    }

    function startNewSet() {
      hideGameOverModal();
      if (lastWinningTeam === 'A') {
        setsA++;
      } else if (lastWinningTeam === 'B') {
        setsB++;
      }
      scoreA = 0;
      scoreB = 0;
      gameEnded = false;
      document.getElementById("scoreA").textContent = 0;
      document.getElementById("scoreB").textContent = 0;
      updateSetsDisplay();
      displayMessage('Novo Set Iniciado!', "info");
      updateSwapTeamsButtonVisibility(); 
      
      saveAppState();
    }

    function showSuperVictoryAnimation(winningTeamName) {
      const superVictoryModal = document.getElementById('superVictoryModal');
      const superVictoryTeamName = document.getElementById('superVictoryTeamName');
      const confettiContainer = superVictoryModal.querySelector('.confetti-container');

      superVictoryTeamName.textContent = winningTeamName;
      superVictoryModal.classList.add('show');

      confettiContainer.innerHTML = '';

      const colors = ['#FFD700', '#FFA500', '#FF4500', '#FFFFFF', '#007bff', '#dc3545'];
      for (let i = 0; i < 200; i++) {
        const confetti = document.createElement('div');
        confetti.classList.add('confetti-piece');
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 15 + 8}px`;
        confetti.style.height = confetti.style.width;
        
        const startX = Math.random() * window.innerWidth;
        const startY = -Math.random() * window.innerHeight;
        confetti.style.left = `${startX}px`;
        confetti.style.top = `${startY}px`;

        const endX = (Math.random() - 0.5) * window.innerWidth * 2;
        const endY = window.innerHeight + Math.random() * window.innerHeight;
        const rotateDeg = Math.random() * 1080;
        const duration = Math.random() * 2 + 3;
        const delay = Math.random() * 1;

        confetti.style.setProperty('--confetti-end-x', `${endX}px`);
        confetti.style.setProperty('--confetti-end-y', `${endY}px`);
        confetti.style.setProperty('--confetti-rotate-deg', `${rotateDeg}deg`);
        confetti.style.animation = `confettiFall ${duration}s ease-out ${delay}s forwards`;
        confetti.style.opacity = 1;

        confettiContainer.appendChild(confetti);

        confetti.addEventListener('animationend', () => {
          confetti.remove();
        });
      }

      setTimeout(() => {
        superVictoryModal.classList.remove('show');
        showGameOverModal(winningTeamName, 'game_won');
      }, 5000);
    }

    function updateSetsDisplay() {
      const setIndicatorA = document.getElementById('setIndicatorA');
      const setIndicatorB = document.getElementById('setIndicatorB');
      setIndicatorA.innerHTML = '';
      setIndicatorB.innerHTML = '';

      for (let i = 0; i < setsA; i++) {
        const star = document.createElement('i');
        star.classList.add('fa-solid', 'fa-star', 'set-star');
        setIndicatorA.appendChild(star);
      }
      for (let i = 0; i < setsB; i++) {
        const star = document.createElement('i');
        star.classList.add('fa-solid', 'fa-star', 'set-star');
        setIndicatorB.appendChild(star);
      }
    }

    function saveSettings() {
      winningScore = parseInt(document.getElementById('winningScore').value);
      setsToWin = parseInt(document.getElementById('setsToWinConfig').value);
      vibrationEnabled = document.getElementById('vibrationEnabled').checked;
      showPlayersOnScoreboard = document.getElementById('showPlayersOnScoreboard').checked;

      if (isNaN(winningScore) || winningScore <= 0) {
        winningScore = 15;
        document.getElementById('winningScore').value = 15;
      }
      if (isNaN(setsToWin) || setsToWin < 0) {
        setsToWin = 1;
        document.getElementById('setsToWinConfig').value = 1;
      }

      for (let i = 0; i < 5; i++) {
        customTeamNames[i] = {
            name: document.getElementById(`customTeamName${i + 1}`).value.trim(),
            color: document.getElementById(`customTeamColor${i + 1}`).value
        };
      }

      localStorage.setItem('winningScore', winningScore.toString());
      localStorage.setItem('setsToWin', setsToWin.toString());
      localStorage.setItem('vibrationEnabled', JSON.stringify(vibrationEnabled));
      localStorage.setItem('showPlayersOnScoreboard', JSON.stringify(showPlayersOnScoreboard));
      localStorage.setItem('customTeamNames', JSON.stringify(customTeamNames));

      updatePlayerDisplayOnScoreboard();
      applyTeamColorsToScoreboard();
      saveAppState();
    }

    function setTheme(themeName, save = true) {
      if (themeName === 'light') {
        document.body.classList.add('light-theme');
      } else {
        document.body.classList.remove('light-theme');
      }
      currentTheme = themeName;
      if (save) {
        localStorage.setItem('theme', themeName);
        displayMessage('Tema alterado para ' + (themeName === 'dark' ? 'Escuro' : 'Claro') + '!', "info");
        saveAppState();
      }
    }

    function saveAppState() {
        const appState = {
            players: players,
            checkedState: checkedState,
            generatedTeams: generatedTeams,
            currentPlayingTeamA: currentPlayingTeamA,
            currentPlayingTeamB: currentPlayingTeamB,
            scoreA: scoreA,
            scoreB: scoreB,
            setsA: setsA,
            setsB: setsB,
            gameEnded: gameEnded,
            gameStarted: gameStarted,
            lastWinningTeam: lastWinningTeam,
            winningScore: winningScore,
            setsToWin: setsToWin,
            customTeamNames: customTeamNames,
            currentTheme: currentTheme,
            vibrationEnabled: vibrationEnabled,
            showPlayersOnScoreboard: showPlayersOnScoreboard,
        };
        localStorage.setItem('volleyballScoreboardAppState', JSON.stringify(appState));
    }

    function loadSettings() {
      const storedAppState = localStorage.getItem('volleyballScoreboardAppState');
      if (storedAppState) {
          const appState = JSON.parse(storedAppState);

          players = appState.players || [];
          checkedState = appState.checkedState || {};
          generatedTeams = appState.generatedTeams || [];
          currentPlayingTeamA = appState.currentPlayingTeamA || { name: 'Time A', players: [], color: '#007bff' };
          currentPlayingTeamB = appState.currentPlayingTeamB || { name: 'Time B', players: [], color: '#dc3545' };
          scoreA = appState.scoreA || 0;
          scoreB = appState.scoreB || 0;
          setsA = appState.setsA || 0;
          setsB = appState.setsB || 0;
          gameEnded = appState.gameEnded || false;
          gameStarted = appState.gameStarted || false;
          lastWinningTeam = appState.lastWinningTeam || null;
          winningScore = appState.winningScore || 15;
          setsToWin = appState.setsToWin || 1;
          customTeamNames = appState.customTeamNames || defaultCustomTeamColors.map((color, index) => ({ name: "", color: color }));
          currentTheme = appState.currentTheme || 'dark';
          vibrationEnabled = appState.vibrationEnabled !== undefined ? appState.vibrationEnabled : true;
          showPlayersOnScoreboard = appState.showPlayersOnScoreboard !== undefined ? appState.showPlayersOnScoreboard : true;

      } else {
          winningScore = parseInt(localStorage.getItem('winningScore') || '15');
          setsToWin = parseInt(localStorage.getItem('setsToWin') || '1');
          vibrationEnabled = JSON.parse(localStorage.getItem('vibrationEnabled') || 'true');
          generatedTeams = JSON.parse(localStorage.getItem('generatedTeams') || '[]');
          showPlayersOnScoreboard = JSON.parse(localStorage.getItem('showPlayersOnScoreboard') || 'true');
          currentTheme = localStorage.getItem('theme') || 'dark';
          gameStarted = false; 
      }

      teamAColor = currentPlayingTeamA.color;
      teamBColor = currentPlayingTeamB.color;

      document.getElementById('winningScore').value = winningScore;
      document.getElementById('setsToWinConfig').value = setsToWin;
      document.getElementById('vibrationEnabled').checked = vibrationEnabled;
      document.getElementById('showPlayersOnScoreboard').checked = showPlayersOnScoreboard;
      
      for (let i = 0; i < 5; i++) {
        document.getElementById(`customTeamName${i + 1}`).value = customTeamNames[i].name;
        document.getElementById(`customTeamColor${i + 1}`).value = customTeamNames[i].color;
      }

      document.getElementById('themeSelect').value = currentTheme;
      setTheme(currentTheme, false);
      
      updateScoreboardTeamsDisplay();
      updateResetButtonVisibility();
      updatePlayerDisplayOnScoreboard();
      applyTeamColorsToScoreboard();
      updateSwapTeamsButtonVisibility(); 
      
      const generalContent = document.getElementById('generalSettingsContent');
      const generalArrow = document.getElementById('generalSettingsArrow');
      const customNamesContent = document.getElementById('customTeamNamesContent');
      const customNamesArrow = document.getElementById('customTeamNamesArrow');
      const dataManagementContent = document.getElementById('dataManagementContent');
      const dataManagementArrow = document.getElementById('dataManagementArrow');


      generalContent.classList.add('show');
      generalArrow.classList.add('rotated');

      customNamesContent.classList.remove('show');
      customNamesArrow.classList.remove('rotated');

      dataManagementContent.classList.remove('show');
      dataManagementArrow.classList.remove('rotated');
    }

    function applyTeamColorsToScoreboard() {
        document.getElementById('sectionA').style.backgroundColor = teamAColor;
        document.getElementById('sectionB').style.backgroundColor = teamBColor;
    }

    function setupSwipeBetweenSections() {
      let touchStartX = null;
      document.body.addEventListener('touchstart', e => {
        if (document.getElementById("gearMenu").classList.contains("show") ||
            document.getElementById("gameOverModal").classList.contains("show") ||
            document.getElementById("increaseScoreModal").classList.contains("show") ||
            document.getElementById("startGameModal").classList.contains("show") ||
            document.getElementById("superVictoryModal").classList.contains("show") ||
            document.getElementById("customMessageModal").classList.contains("show") || 
            document.getElementById("customConfirmationModal").classList.contains("show") || 
            document.getElementById("manageTeamModal").classList.contains("show") ||
            e.target.closest('#startGameButton') || e.target.closest('#swapTeamsButton')) {
            touchStartX = null;
            return;
        }
        touchStartX = e.touches[0].clientX;
      });
      document.body.addEventListener('touchend', e => {
        if (touchStartX === null) return;

        const touchEndX = e.changedTouches[0].clientX;
        const dx = touchStartX - touchEndX;
        const threshold = 50;

        if (e.target.closest('#startGameButton') || e.target.closest('#swapTeamsButton')) {
            touchStartX = null;
            return;
        }

        const sections = ['pontuacao', 'times', 'jogadores', 'configuracoes']; // Ordem atualizada
        const currentIndex = sections.findIndex(id => document.getElementById(id).classList.contains('active'));
        let nextIndex = currentIndex;
        
        if (dx > threshold) {
          nextIndex = (currentIndex + 1) % sections.length;
        } else if (dx < -threshold) {
          nextIndex = (currentIndex - 1 + sections.length) % sections.length;
        }
        showSection(sections[nextIndex]);
        touchStartX = null;
      });
    }

    function swapTeams() {
      if (!gameStarted) {
        displayMessage("Inicie uma partida para inverter os times.", "warning");
        return;
      }
      
      const sectionA = document.getElementById('sectionA');
      const sectionB = document.getElementById('sectionB');

      sectionA.style.pointerEvents = 'none';
      sectionB.style.pointerEvents = 'none';
      document.getElementById('swapTeamsButton').style.pointerEvents = 'none';

      const animationDuration = 300;

      sectionA.classList.add('fade-out');
      sectionB.classList.add('fade-out');

      setTimeout(() => {
        let tempScore = scoreA;
        scoreA = scoreB;
        scoreB = tempScore;

        let tempSets = setsA;
        setsA = setsB;
        setsB = tempSets;

        let tempTeam = currentPlayingTeamA;
        currentPlayingTeamA = currentPlayingTeamB;
        currentPlayingTeamB = tempTeam;

        let tempColor = teamAColor;
        teamAColor = teamBColor;
        teamBColor = tempColor;

        localStorage.setItem('currentPlayingTeamA', JSON.stringify(currentPlayingTeamA));
        localStorage.setItem('currentPlayingTeamB', JSON.stringify(currentPlayingTeamB));

        document.getElementById("scoreA").textContent = scoreA;
        document.getElementById("scoreB").textContent = scoreB;
        updateSetsDisplay();
        updateScoreboardTeamsDisplay();
        applyTeamColorsToScoreboard();

        sectionA.classList.remove('fade-out');
        sectionB.classList.remove('fade-out');
        sectionA.classList.add('fade-in');
        sectionB.classList.add('fade-in');

        setTimeout(() => {
          sectionA.classList.remove('fade-in');
          sectionB.classList.remove('fade-in');
          sectionA.style.pointerEvents = 'auto';
          sectionB.style.pointerEvents = 'auto';
          document.getElementById('swapTeamsButton').style.pointerEvents = 'auto';
        }, animationDuration);

      }, animationDuration);
      saveAppState();
    }

    function updateSwapTeamsButtonVisibility() {
        const swapButton = document.getElementById('swapTeamsButton');
        if (gameStarted && !gameEnded) {
            swapButton.classList.add('show');
        } else {
            swapButton.classList.remove('show');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const customModalHTML = `
            <div id="customMessageModal" class="custom-message-modal">
                <div class="modal-content custom-message-content">
                    <h3 id="customMessageTitle"></h3>
                    <p id="customMessageText"></p>
                    <div class="modal-buttons">
                        <button onclick="hideCustomMessageModal()">OK</button>
                    </div>
                </div>
            </div>
            <div id="customConfirmationModal" class="custom-confirmation-modal">
                <div class="modal-content custom-confirmation-content">
                    <h3 id="customConfirmationTitle">Confirmação</h3>
                    <p id="customConfirmationText"></p>
                    <div class="modal-buttons">
                        <button id="confirmYesButton">Sim</button>
                        <button id="confirmNoButton" style="background-color: #dc3545; --modal-button-hover-bg: #c82333;">Não</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', customModalHTML);

        document.getElementById('confirmYesButton').addEventListener('click', () => {
            if (typeof window.currentConfirmationCallback === 'function') {
                window.currentConfirmationCallback(true);
            }
            hideCustomConfirmationModal();
        });

        document.getElementById('confirmNoButton').addEventListener('click', () => {
            if (typeof window.currentConfirmationCallback === 'function') {
                window.currentConfirmationCallback(false);
            }
            hideCustomConfirmationModal();
        });
    });

    function displayMessage(message, type = 'info') {
        const modal = document.getElementById('customMessageModal');
        const titleElement = document.getElementById('customMessageTitle');
        const textElement = document.getElementById('customMessageText');

        let title = '';
        switch (type) {
            case 'success': title = 'Sucesso!'; break;
            case 'error': title = 'Erro!'; break;
            case 'warning': title = 'Atenção!'; break;
            default: title = 'Informação'; break;
        }

        titleElement.textContent = title;
        textElement.textContent = message;
        modal.classList.add('show');
    }

    function hideCustomMessageModal() {
        document.getElementById('customMessageModal').classList.remove('show');
    }

    function showConfirmationModal(message, callback) {
        const modal = document.getElementById('customConfirmationModal');
        const textElement = document.getElementById('customConfirmationText');
        textElement.textContent = message;
        window.currentConfirmationCallback = callback;
        modal.classList.add('show');
    }

    function hideCustomConfirmationModal() {
        document.getElementById('customConfirmationModal').classList.remove('show');
        window.currentConfirmationCallback = null;
    }

    function showManageTeamModal(teamId) {
        activeManageTeamId = teamId;
        const modal = document.getElementById('manageTeamModal');
        const selectElement = document.getElementById('selectTeamForManagement');
        
        document.getElementById('manageTeamModalTitle').textContent = `Selecionar Time`;

        const currentTeam = (teamId === 'A' ? currentPlayingTeamA : currentPlayingTeamB);

        selectElement.innerHTML = '<option value="">Selecione um time</option>';

        if (generatedTeams.length === 0) {
            selectElement.innerHTML += '<option value="" disabled>Nenhum time gerado</option>';
        } else {
            generatedTeams.forEach((team, index) => {
                const option = document.createElement('option');
                option.value = `generated-${index}`;
                option.textContent = `${team.name}`;
                selectElement.appendChild(option);
            });
        }

        let foundInDropdown = false;
        const generatedIndex = generatedTeams.findIndex(t => t.name === currentTeam.name && t.players.length === currentTeam.players.length && t.players.every((p, i) => p === currentTeam.players[i]));
        if (generatedIndex !== -1) {
            selectElement.value = `generated-${generatedIndex}`;
            foundInDropdown = true;
        }

        if (!foundInDropdown) {
            selectElement.value = "";
        }

        modal.classList.add('show');

        setTimeout(() => {
            document.addEventListener('click', closeManageTeamModalOnOutsideClick);
        }, 0);
    }

    function closeManageTeamModalOnOutsideClick(e) {
      const modal = document.getElementById("manageTeamModal");
      const modalContent = modal.querySelector(".modal-content");
      if (!modalContent.contains(e.target)) {
        hideManageTeamModal();
      }
    }

    function hideManageTeamModal() {
        document.getElementById('manageTeamModal').classList.remove('show');
        activeManageTeamId = null;
        document.removeEventListener('click', closeManageTeamModalOnOutsideClick);
    }

    function saveTeamNameAndPlayers() {
        const selectedDropdownValue = document.getElementById('selectTeamForManagement').value;

        let targetTeam = (activeManageTeamId === 'A' ? currentPlayingTeamA : currentPlayingTeamB);
        let otherTeam = (activeManageTeamId === 'A' ? currentPlayingTeamB : currentPlayingTeamA);

        let finalTeamName;
        let finalTeamPlayers;
        let finalTeamColor;

        if (selectedDropdownValue === "") {
            finalTeamName = (activeManageTeamId === 'A' ? 'Time A' : 'Time B');
            finalTeamPlayers = [];
            finalTeamColor = (activeManageTeamId === 'A' ? '#007bff' : '#dc3545');
        } else if (selectedDropdownValue.startsWith('generated-')) {
            const index = parseInt(selectedDropdownValue.split('-')[1]);
            const selectedGeneratedTeam = generatedTeams[index];

            if (otherTeam.name === selectedGeneratedTeam.name && otherTeam.players.length === selectedGeneratedTeam.players.length && otherTeam.players.every((p, i) => p === selectedGeneratedTeam.players[i])) {
                displayMessage("Este time gerado já está atribuído ao outro time. Por favor, selecione um time diferente.", "warning");
                return;
            }
            finalTeamName = selectedGeneratedTeam.name;
            finalTeamPlayers = selectedGeneratedTeam.players;
            finalTeamColor = selectedGeneratedTeam.color;
        }

        targetTeam.name = finalTeamName;
        targetTeam.players = finalTeamPlayers;
        targetTeam.color = finalTeamColor;

        localStorage.setItem('currentPlayingTeamA', JSON.stringify(currentPlayingTeamA));
        localStorage.setItem('currentPlayingTeamB', JSON.stringify(currentPlayingTeamB));
        
        if (activeManageTeamId === 'A') {
            teamAColor = finalTeamColor;
        } else {
            teamBColor = finalTeamColor;
        }

        updateScoreboardTeamsDisplay();
        hideManageTeamModal();
        saveAppState();
    }

    function toggleCustomTeamNamesSection() {
        const content = document.getElementById('customTeamNamesContent');
        const arrow = document.getElementById('customTeamNamesArrow');
        content.classList.toggle('show');
        arrow.classList.toggle('rotated');
    }

    function toggleGeneralSettingsSection() {
        const content = document.getElementById('generalSettingsContent');
        const arrow = document.getElementById('generalSettingsArrow');
        content.classList.toggle('show');
        arrow.classList.toggle('rotated');
    }

    function toggleDataManagementSection() {
        const content = document.getElementById('dataManagementContent');
        const arrow = document.getElementById('dataManagementArrow');
        content.classList.toggle('show');
        arrow.classList.toggle('rotated');
    }

    function updatePlayerDisplayOnScoreboard() {
        const playerInfoContainerA = document.querySelector('#sectionA .player-info-container');
        const playerInfoContainerB = document.querySelector('#sectionB .player-info-container');
        if (showPlayersOnScoreboard) {
            playerInfoContainerA.classList.remove('hidden-players');
            playerInfoContainerB.classList.remove('hidden-players');
        } else {
            playerInfoContainerA.classList.add('hidden-players');
            playerInfoContainerB.classList.add('hidden-players');
        }
    }

    function exportSettings() {
        const appState = {
            players: players,
            checkedState: checkedState,
            generatedTeams: generatedTeams,
            currentPlayingTeamA: currentPlayingTeamA,
            currentPlayingTeamB: currentPlayingTeamB,
            scoreA: scoreA,
            scoreB: scoreB,
            setsA: setsA,
            setsB: setsB,
            gameEnded: gameEnded,
            gameStarted: gameStarted,
            lastWinningTeam: lastWinningTeam,
            winningScore: winningScore,
            setsToWin: setsToWin,
            customTeamNames: customTeamNames,
            currentTheme: currentTheme,
            vibrationEnabled: vibrationEnabled,
            showPlayersOnScoreboard: showPlayersOnScoreboard,
        };

        const dataStr = JSON.stringify(appState, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'placar_volei_config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        displayMessage("Configurações exportadas com sucesso!", "success");
    }

    function importSettings(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedAppState = JSON.parse(e.target.result);
                
                players = importedAppState.players || [];
                checkedState = importedAppState.checkedState || {};
                generatedTeams = importedAppState.generatedTeams || [];
                currentPlayingTeamA = importedAppState.currentPlayingTeamA || { name: 'Time A', players: [], color: '#007bff' };
                currentPlayingTeamB = importedAppState.currentPlayingTeamB || { name: 'Time B', players: [], color: '#dc3545' };
                scoreA = importedAppState.scoreA || 0;
                scoreB = importedAppState.scoreB || 0;
                setsA = importedAppState.setsA || 0;
                setsB = importedAppState.setsB || 0;
                gameEnded = importedAppState.gameEnded || false;
                gameStarted = importedAppState.gameStarted || false;
                lastWinningTeam = importedAppState.lastWinningTeam || null;
                winningScore = importedAppState.winningScore || 15;
                setsToWin = importedAppState.setsToWin || 1;
                customTeamNames = importedAppState.customTeamNames || defaultCustomTeamColors.map((color, index) => ({ name: "", color: color }));
                currentTheme = importedAppState.currentTheme || 'dark';
                vibrationEnabled = importedAppState.vibrationEnabled !== undefined ? importedAppState.vibrationEnabled : true;
                showPlayersOnScoreboard = importedAppState.showPlayersOnScoreboard !== undefined ? importedAppState.showPlayersOnScoreboard : true;

                document.getElementById('winningScore').value = winningScore;
                document.getElementById('setsToWinConfig').value = setsToWin;
                document.getElementById('vibrationEnabled').checked = vibrationEnabled;
                document.getElementById('showPlayersOnScoreboard').checked = showPlayersOnScoreboard;
                document.getElementById('themeSelect').value = currentTheme;
                setTheme(currentTheme, false);

                for (let i = 0; i < 5; i++) {
                    document.getElementById(`customTeamName${i + 1}`).value = customTeamNames[i].name;
                    document.getElementById(`customTeamColor${i + 1}`).value = customTeamNames[i].color;
                }

                updatePlayerList();
                updateSetsDisplay();
                updateScoreboardTeamsDisplay();
                applyTeamColorsToScoreboard();
                updateSwapTeamsButtonVisibility();

                if (gameStarted && !gameEnded) {
                } else {
                }

                if (gameStarted && !gameEnded) {
                    document.getElementById('startGameButton').style.display = 'none';
                    document.getElementById('scoreboardOverlay').classList.add('hidden');
                } else {
                    document.getElementById('startGameButton').style.display = 'block';
                    document.getElementById('scoreboardOverlay').classList.remove('hidden');
                }

                saveAppState();
                displayMessage("Configurações importadas com sucesso!", "success");

            } catch (error) {
                console.error("Erro ao importar configurações:", error);
                displayMessage("Erro ao importar arquivo. Verifique se é um arquivo de configurações válido.", "error");
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }

    window.onload = () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(() => {})
          .catch(error => {});
      }

      loadSettings();

      updatePlayerList();
      updateSetsDisplay();
      renderGeneratedTeams();

      setupSwipeToDecrease('sectionA', 'A');
      setupSwipeToDecrease('sectionB', 'B');
      setupSwipeBetweenSections();

      document.getElementById('sectionA').addEventListener('click', (e) => {
        if (e.target.closest('.team-name') || e.target.closest('.player-info-container')) {
            showManageTeamModal('A');
        } else {
            changeScore('A', 1);
        }
      });
      document.getElementById('sectionB').addEventListener('click', (e) => {
        if (e.target.closest('.team-name') || e.target.closest('.player-info-container')) {
            showManageTeamModal('B');
        } else {
            changeScore('B', 1);
        }
      });
      
      // Determina a tela inicial com base no estado do jogo carregado
      if (gameStarted && !gameEnded) {
          // Um jogo estava em andamento, mostra o placar
          document.getElementById('startGameButton').style.display = 'none';
          document.getElementById('scoreboardOverlay').classList.add('hidden');
      } else {
          // Nenhum jogo em andamento ou jogo terminou, garante que o botão de iniciar partida e o overlay estejam visíveis
          document.getElementById('startGameButton').style.display = 'block';
          document.getElementById('scoreboardOverlay').classList.remove('hidden');
      }
    }
  </script>
</body>
</html>
